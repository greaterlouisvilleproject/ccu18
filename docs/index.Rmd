
#Setup

Some notes:
Where I thought the data was too jittery, I included a trendline that uses a rolling average and a trendline that shows each individual years of data.
```{r "setup", include = FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/Harrison Kirby/Desktop/GLP/ccu18")
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

```{r libraries}
#Data
library(survey)
library(tidyverse)
library(magrittr)
library(feather)
library(labelled)

#Graphing
library(ggthemes)
library(classInt)
library(showtext)
library(reshape2)
library(plotly)
library(wesanderson)

#Mapping
library(rgdal)
library(RColorBrewer)
library(leaflet)

#Make the dplyr select function the default over the plotly select function
select <- function(...){dplyr::select(...)}
```

```{r functions}
acs_time <- function(folder, starting_year = 2005){
  wd <- getwd()
  directory <- paste0(wd, folder)
  file_names <- list.files(directory)
  n <- length(file_names)
  y <- starting_year
  for (i in 1:n){
    file_path <- paste0(wd, folder, file_names[i])
    data <- read_csv(file_path, skip=1, col_types = cols("Id2" = col_double()))
    names(data)[names(data) == 'Id2'] <- 'FIPS'
    all_peers <- data %>% filter(FIPS %in% c(1073, 12031, 18097, 21111, 26081, 
                                             29095, 29189, 29510, 31055, 37081, 
                                             37119, 37183, 39049, 39061, 39113, 
                                             40109, 40143, 45045, 47037, 47093, 
                                             47157, 51760))
    
    all_peers$year <- y
    y <- y + 1
    
    if(i == 1){
     df <- all_peers 
    }
    else{
      names(all_peers) <- names(df)
      df <- rbind(df, all_peers)
    }
  }
  df
}

wonder_time <- function(folder, geog_type){
  wd <- getwd()
  wd <- paste(wd, folder, sep = "/")
  file_names <- list.files(wd)
  file_geog <- substr(file_names, 1, 5)
  n <- length(file_names)
  
  for (i in 1:n){
    file_path <- paste(wd, file_names[i], sep = "/")
    data <- read_tsv(file_path)
    
    output <- data %>% filter(!is.na(Year))
    output[[geog_type]] <- file_geog[i]
    
    if(i == 1){df <- output}
    else{df <- rbind(df, output)}
    
  }
  df
}

brfss_time <- function(start_year = 2002){
  wd <- getwd()
  wd <- paste(wd, "brfss_download", sep = "/")
  file_names <- list.files(wd)
  n <- length(file_names)
  y <- start_year
  
  for (i in 1:n){
    file_path <- paste(wd, file_names[i], sep = "/")
    data <- sasxport.get(file_path)
    
    data <- map_df(data, remove_var_label)

    if(y == 2002){
      output <- data.frame(msa = data$a.mmsa, 
                           wgt = data$a.mmsawt, 
                           obs = data$seqno,
                           age = data$age.mmsa,
                           hlth = data$genhlth, 
                           physdays = data$physhlth, 
                           mentdays = data$menthlth)
    } 
    else if(y == 2003){
      output <- data.frame(msa = data$x.mmsa, 
                           wgt = data$x.lmmsawt,
                           obs = data$seqno,
                           age = data$x.ageg.,
                           hlth = data$genhlth, 
                           physdays = data$physhlth, 
                           mentdays = data$menthlth)
    }
    else if(y >= 2004 & y <= 2010){
      output <- data.frame(msa = data$x.mmsa, 
                           wgt = data$x.mmsawt,
                           obs = data$seqno,
                           age = data$age.mmsa,
                           hlth = data$genhlth, 
                           physdays = data$physhlth, 
                           mentdays = data$menthlth)
    }
    else if(y >= 2011){
      output <- data.frame(msa = data$x.mmsa, 
                           wgt = data$x.mmsawt,
                           obs = data$seqno,
                           age = data$x.age.g,
                           hlth = data$genhlth, 
                           physdays = data$physhlth, 
                           mentdays = data$menthlth)
      
      }
      
    output$year <- y
    y <- y + 1
    
    if(i == 1){df <- output}
    else{df <- rbind(df, output)}
    
  }
  df
}

insurance_time <- function(directory = "", starting.year=2008){
  wd <- getwd()
  file_names <- list.files(directory)
  n<-length(file_names)
  y<-starting.year
  for (i in 1:n){
    file_path <- paste(directory, file_names[i], sep = "")
    data<-read_csv(file_path, skip=79)
    
    if(y > 2007){ data <- data %>% select(-X26) }
    
    data$statefips <- as.character(data$statefips)
    data$countyfips <- as.character(data$countyfips)
    
    data$statefips <- if_else( nchar(data$statefips) < 2, paste0("0",data$statefips), data$statefips)
    data$countyfips <- if_else( nchar(data$countyfips) < 3, paste0("0",data$countyfips), data$countyfips)
    data$countyfips <- if_else( nchar(data$countyfips) < 3, paste0("0",data$countyfips), data$countyfips)
    
    data$FIPS <- as.numeric(paste0(data$statefips, data$countyfips))
    all.peers <-subset(data, data$FIPS == 1073 |data$FIPS == 37119
                       |data$FIPS == 39061 |data$FIPS == 39049
                       |data$FIPS == 26081 |data$FIPS == 37081
                       |data$FIPS == 45045 |data$FIPS == 18097
                       |data$FIPS == 29095 |data$FIPS == 47093
                       |data$FIPS == 21111 |data$FIPS == 47157
                       |data$FIPS == 47037 |data$FIPS == 40109
                       |data$FIPS == 31055 |data$FIPS == 29189
                       |data$FIPS == 29510
                       |data$FIPS == 40143 |data$FIPS == 39113
                       |data$FIPS == 12031 |data$FIPS == 37183
                       |data$FIPS == 51760)
    
    all.peers$year<-y
    y<-y+1
    
    if(i==1){
     df<-all.peers 
    }
    else{
      names(all.peers)<-names(df)
      df<-rbind(df, all.peers)
    }
  }
  df
}

pull_peers_MSA<-function(data){
  all.peers <- filter(data, data$MSA %in% c("24340", "41180", "36420", "46140", "24860", "28940", "13820", "26900", "31140", "28140", "36540", "24660", "16740", "18140", "17140", "34980", "32820", "27260", "39580", "19380", "40060"))
  
  all.peers$baseline <- 1
  all.peers$current  <- 1
  
  all.peers$baseline[all.peers$MSA == 24340 | all.peers$MSA == 41180
                     |all.peers$MSA == 36420 | all.peers$MSA == 46140
                     |all.peers$MSA == 24860 | all.peers$MSA == 28940] <-0
  
  all.peers$current[all.peers$MSA == 27260 | all.peers$MSA == 39580
                    |all.peers$MSA == 19380 | all.peers$MSA == 40060] <-0
  all.peers
}

pull_peers_FIPS <- function(dat){
  all.peers <- subset(dat, dat$FIPS == 1073 | dat$FIPS == 37119
                      |dat$FIPS == 39061 |dat$FIPS == 39049
                      |dat$FIPS == 26081 |dat$FIPS == 37081
                      |dat$FIPS == 45045 |dat$FIPS == 18097
                      |dat$FIPS == 29095 |dat$FIPS == 47093
                      |dat$FIPS == 21111 |dat$FIPS == 47157
                      |dat$FIPS == 47037 |dat$FIPS == 40109
                      |dat$FIPS == 31055 |dat$FIPS == 29189
                      |dat$FIPS == 29510 |dat$FIPS == 40143
                      |dat$FIPS == 12031 |dat$FIPS == 37183
                      |dat$FIPS == 39113 |dat$FIPS == 51760
                      |dat$FIPS == "01073" | dat$FIPS == "MERGED")
  all.peers$baseline <- 1
  all.peers$current <- 1
  all.peers$baseline[all.peers$FIPS==26081|all.peers$FIPS==29189
                     |all.peers$FIPS==29510|all.peers$FIPS==40109
                     |all.peers$FIPS==40143|all.peers$FIPS==45045
                     |all.peers$FIPS==47093|all.peers$FIPS=="MERGED"]<-0
  all.peers$current[all.peers$FIPS== 12031|all.peers$FIPS==37183|
                      all.peers$FIPS==39113|all.peers$FIPS==51760]<-0
  
  city <- c('Grand Rapids', 'St. Louis', 'Oklahoma City', 'Tulsa', 'Greenville', 'Knoxville', 
            'Birmingham', 'Indianapolis', 'Louisville', 'Kansas City', 'Omaha', 'Greensboro', 
            'Charlotte', 'Columbus', 'Cincinnati', 'Nashville', 'Memphis', 'Jacksonville', 
            'Raleigh', 'Dayton', 'Richmond')
  
  FIPS_codes <- c(26081, 'MERGED', 40109, 40143, 45045, 47093, 1073, 18097, 21111, 29095, 31055, 
                  37081, 37119, 39049, 39061, 47037, 47157, 12031, 37183, 39113, 51760)
  
  names_df <- data.frame(city, FIPS_codes)
  
  all.peers <- left_join(all.peers, names_df, by = c('FIPS' = 'FIPS_codes'))
  all.peers
}

weight_stl <- function(df_original, variables, weight_variable = ""){

  n <- 1
  
  if(weight_variable == ""){
    population_data <- read_csv("data/population_data.csv")
    if(typeof(df_original$FIPS) == 'character'){
      population_data$FIPS <- as.character(population_data$FIPS)
    }
    df_original <- df_original %>% left_join(population_data, by = c("FIPS", "year"))
    weight_variable <- 'population'
  }
  
  for(v in 1:length(variables)){
    df  <- df_original[,c('FIPS', 'year', variables[n], weight_variable)]
  
    df$var <- df[[variables[n]]]
    df$weight_var <- df[[weight_variable]]
    
    df %<>%
      mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
      group_by(FIPS, year) %>%
      summarise(var = weighted.mean(var, weight_var)) %>%
      ungroup()
    
    df[[variables[n]]] <- df$var
    
    df %<>% select(-var)
    
    if(n == 1){
      output <- df
    }else{
      output <- full_join(output, df, by = c('FIPS', 'year'))
    }
    
    n = n + 1
    
  }
  output
}

bind_df <- function(...){
  data_frames <- list(...)
  output <- reduce(data_frames, full_join, by = c('FIPS', 'year'))
  output
}

rpp_col_adj <- function(x){
  x *  data$rpp_index * data$cpi_index
}
```

```{r graphing}
source('C:/Users/Harrison Kirby/Desktop/GLP/glp_website/graphing_functions.R')
font_add("Museo Sans 300", "MuseoSans_300.otf")
font_add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")

showtext.auto()

#Tract Map
map_jc = readOGR('data/maps/tract', layer = "JC Tracts",
                 GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_jc$TRACT <- as.numeric(map_jc$TRACT)

nh_names <- read_csv('data/maps/tract_to_nh.csv')

nh_names$Id2 <- substr(nh_names$Id2, 6, 13)
nh_names$Id2 <- as.numeric(nh_names$Id2)

map_jc@data <- full_join(map_jc@data, nh_names, by = c('TRACT' = 'Id2'))

map_jc@data$l_line1 <- paste("Tract #:", map_jc@data$TRACT, "in the")
map_jc@data$l_line2 <- paste(map_jc@data$Neighborhood, "neighborhood")

rm(nh_names)

#Zip Code map
map_jc_zip = readOGR('data/maps/zip', layer = 'Jefferson_County_KY_ZIP_Codes',
                     GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_jc_zip$ZIPCODE <- as.numeric(map_jc_zip$ZIPCODE)

map_jc_zip@data$l_line1 <- paste0("Zip Code ", map_jc_zip@data$ZIPCODE)
```

```{r Website / output toggle}
web = TRUE
```

# Education : Bachelor Degree Attainment ages 25-64 {.tabset}

## Ranking
```{r data1}
degree_df <- acs_time("/data/education/B15001/")

degree_df %<>%
  mutate(
    num_25_34 = 
      `Estimate; Male: - 25 to 34 years:` +
      `Estimate; Female: - 25 to 34 years:`,
    num_25_64 = 
      `Estimate; Male: - 25 to 34 years:` +
      `Estimate; Male: - 35 to 44 years:` +
      `Estimate; Male: - 45 to 64 years:` +
      `Estimate; Female: - 25 to 34 years:` +
      `Estimate; Female: - 35 to 44 years:` +
      `Estimate; Female: - 45 to 64 years:`,
    
    num_25_34_grad = 
      `Estimate; Male: - 25 to 34 years: - Graduate or professional degree` + 
      `Estimate; Female: - 25 to 34 years: - Graduate or professional degree`,
    
    num_25_64_grad = 
      `Estimate; Male: - 25 to 34 years: - Graduate or professional degree` +
      `Estimate; Male: - 35 to 44 years: - Graduate or professional degree` +
      `Estimate; Male: - 45 to 64 years: - Graduate or professional degree` +
      `Estimate; Female: - 25 to 34 years: - Graduate or professional degree` +
      `Estimate; Female: - 35 to 44 years: - Graduate or professional degree` +
      `Estimate; Female: - 45 to 64 years: - Graduate or professional degree`,
    
    num_25_34_bach_plus = 
      `Estimate; Male: - 25 to 34 years: - Bachelor's degree` + 
      `Estimate; Female: - 25 to 34 years: - Bachelor's degree` +
      num_25_34_grad,
    
    num_25_64_bach_plus = 
      `Estimate; Male: - 25 to 34 years: - Bachelor's degree` +
      `Estimate; Male: - 35 to 44 years: - Bachelor's degree` +
      `Estimate; Male: - 45 to 64 years: - Bachelor's degree` +
      `Estimate; Female: - 25 to 34 years: - Bachelor's degree` +
      `Estimate; Female: - 35 to 44 years: - Bachelor's degree` +
      `Estimate; Female: - 45 to 64 years: - Bachelor's degree` +
      num_25_64_grad,
    
    num_25_34_assoc_plus = 
      `Estimate; Male: - 25 to 34 years: - Associate's degree` +
      `Estimate; Female: - 25 to 34 years: - Associate's degree` +
      num_25_34_bach_plus,
    
    num_25_64_assoc_plus = 
      `Estimate; Male: - 25 to 34 years: - Associate's degree` +
      `Estimate; Male: - 35 to 44 years: - Associate's degree` +
      `Estimate; Male: - 45 to 64 years: - Associate's degree` +
      `Estimate; Female: - 25 to 34 years: - Associate's degree` +
      `Estimate; Female: - 35 to 44 years: - Associate's degree` +
      `Estimate; Female: - 45 to 64 years: - Associate's degree` +
      num_25_64_bach_plus,
    
    per_25_34_assoc_plus = num_25_34_assoc_plus / num_25_34 * 100,
    per_25_64_assoc_plus = num_25_64_assoc_plus / num_25_64 * 100,
    
    per_25_34_bach_plus = num_25_34_bach_plus / num_25_34 * 100,
    per_25_64_bach_plus = num_25_64_bach_plus / num_25_64 * 100,
    
    per_25_34_grad = num_25_34_grad / num_25_34 * 100,
    per_25_64_grad = num_25_64_grad / num_25_64 * 100) %>%
    {
      x <- .
      full_join(
        x %>% weight_stl(c('per_25_34_assoc_plus', 'per_25_34_bach_plus', 'per_25_34_grad'), 'num_25_34'),
        x %>% weight_stl(c('per_25_64_assoc_plus', 'per_25_64_bach_plus', 'per_25_64_grad'), 'num_25_64'))
    }

data <- degree_df

data %<>% pull_peers_FIPS() %>% select(FIPS, city, year, current, baseline, everything())

rm(degree_df)
```

```{r graph1}
rank_and_nb_group(data[data$year == 2016,], 
                  'per_25_64_bach_plus', 
                  plot_title = 'Bachelor Degrees, Ages 25-64, 2016')
```

## Trendline by ethnicity
```{r data2}
#White
degree_white_05 <- acs_time("/data/education/B15002H/Y05/", starting_year = 2005)
degree_white_08 <- acs_time("/data/education/B15002H/Y08/", starting_year = 2008)

degree_white_05 <- degree_white_05 %>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_white =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_white = 
        (`Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100) %>%
  select(FIPS, year, assoc_plus_per_white, bach_plus_per_white, total)

degree_white_08 <- degree_white_08 %>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_white =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_white = 
        (`Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
         /total * 100) %>%
  select(FIPS, year, assoc_plus_per_white, bach_plus_per_white, total)

degree_white <- bind_rows(degree_white_05, degree_white_08) %>%
  weight_stl(c('assoc_plus_per_white', 'bach_plus_per_white'), 'total')

#Black
degree_black_05 = acs_time("/data/education/B15002B/Y05/", starting_year = 2005)
degree_black_08 = acs_time("/data/education/B15002B/Y08/", starting_year = 2008)

degree_black_05 %<>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_black =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_black = 
        (`Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        /total * 100) %>%
  select(FIPS, year, assoc_plus_per_black, bach_plus_per_black, total)

degree_black_08 %<>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_black =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_black = 
        (`Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        /total * 100) %>% 
  select(FIPS, year, assoc_plus_per_black, bach_plus_per_black, total)

degree_black = bind_rows(degree_black_05, degree_black_08) %>%
  weight_stl(c('assoc_plus_per_black', 'bach_plus_per_black'), 'total')

#Hispanic
degree_hispanic_05 = acs_time("/data/education/B15002I/Y05/", starting_year = 2005)
degree_hispanic_08 = acs_time("/data/education/B15002I/Y08/", starting_year = 2008)

degree_hispanic_05 = degree_hispanic_05 %>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_hispanic =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_hispanic = 
      (`Estimate; Female: - Bachelor's degree` + 
       `Estimate; Male: - Bachelor's degree` + 
       `Estimate; Female: - Graduate degree` + 
       `Estimate; Male: - Graduate degree`)
      /total * 100) %>%
  select(FIPS, year, assoc_plus_per_hispanic, bach_plus_per_hispanic, total)

degree_hispanic_08 = degree_hispanic_08 %>%
  mutate(
    total = `Estimate; Total:`,
    
    assoc_plus_per_hispanic =
        (`Estimate; Female: - Associate's degree` +
        `Estimate; Male: - Associate's degree` +
        `Estimate; Female: - Bachelor's degree` + 
        `Estimate; Male: - Bachelor's degree` + 
        `Estimate; Female: - Graduate degree` + 
        `Estimate; Male: - Graduate degree`)
        / total * 100,
    
    bach_plus_per_hispanic = 
      (`Estimate; Female: - Bachelor's degree` + 
       `Estimate; Male: - Bachelor's degree` + 
       `Estimate; Female: - Graduate degree` + 
       `Estimate; Male: - Graduate degree`)
      /total * 100) %>%
  select(FIPS, year, assoc_plus_per_hispanic, bach_plus_per_hispanic, total)

degree_hispanic = bind_rows(degree_hispanic_05, degree_hispanic_08) %>%
  weight_stl(c('assoc_plus_per_hispanic', 'bach_plus_per_hispanic'), 'total')

data %<>% bind_df(degree_white, degree_black, degree_hispanic)

rm(degree_white_05, degree_white_08, degree_white, degree_black_05, degree_black_08, degree_black, degree_hispanic_05, degree_hispanic_08, degree_hispanic)
```

```{r graph2}
graph_df <- data%>%
filter(FIPS == 21111)%>%
  select(year, bach_plus_per_white, bach_plus_per_black, bach_plus_per_hispanic) %>%
  mutate_at(vars(bach_plus_per_white, bach_plus_per_black, bach_plus_per_hispanic), rollmean3) %>%
  gather(bach_plus_per_white:bach_plus_per_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2006,
  xmax = 2015,
  plot_title = "Bachelor Degrees by Ethnicity",
  subtitle_text = '3-year rolling average',
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))

graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, bach_plus_per_white, bach_plus_per_black, bach_plus_per_hispanic)%>%
  gather(bach_plus_per_white:bach_plus_per_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2005,
  xmax = 2016,
  plot_title = "Bachelor Degrees by Ethnicity",
  subtitle_text = '1-year values',
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))
```

It's a bit tough to break down the data by race and include peer city information on the same graph, since that ends up with 12 lines to fit on the page. The third graph I included here tries to do that. The solid line represents Louisville, the dashed line represents our peer average, and the shaded area represents the 25th and 75th percentiles of our peers. The Bachelor degree version is very messy since the lines for black and hispanic are overlapping so much.

```{r graph2.1}
graph_trendline_race_peer(data, 
                          vars = c('bach_plus_per_white', 'bach_plus_per_black', 'bach_plus_per_hispanic'),
                          plot_title = 'Bachelor Degrees by Ethnicity',
                          rollmean = 5)
```

## Map
```{r data3}
degree_map <- read_csv('Data/Education/ACS_16_5YR_B15001_with_ann.csv', skip = 1)

degree_map %<>%
  mutate(
    num_25_34 = 
      `Estimate; Male: - 25 to 34 years:` +
      `Estimate; Female: - 25 to 34 years:`,
    num_25_64 = 
      `Estimate; Male: - 25 to 34 years:` +
      `Estimate; Male: - 35 to 44 years:` +
      `Estimate; Male: - 45 to 64 years:` +
      `Estimate; Female: - 25 to 34 years:` +
      `Estimate; Female: - 35 to 44 years:` +
      `Estimate; Female: - 45 to 64 years:`,
    
    num_25_34_grad = 
      `Estimate; Male: - 25 to 34 years: - Graduate or professional degree` + 
      `Estimate; Female: - 25 to 34 years: - Graduate or professional degree`,
    
    num_25_64_grad = 
      `Estimate; Male: - 25 to 34 years: - Graduate or professional degree` +
      `Estimate; Male: - 35 to 44 years: - Graduate or professional degree` +
      `Estimate; Male: - 45 to 64 years: - Graduate or professional degree` +
      `Estimate; Female: - 25 to 34 years: - Graduate or professional degree` +
      `Estimate; Female: - 35 to 44 years: - Graduate or professional degree` +
      `Estimate; Female: - 45 to 64 years: - Graduate or professional degree`,
    
    num_25_34_bach_plus = 
      `Estimate; Male: - 25 to 34 years: - Bachelor's degree` + 
      `Estimate; Female: - 25 to 34 years: - Bachelor's degree` +
      num_25_34_grad,
    
    num_25_64_bach_plus = 
      `Estimate; Male: - 25 to 34 years: - Bachelor's degree` +
      `Estimate; Male: - 35 to 44 years: - Bachelor's degree` +
      `Estimate; Male: - 45 to 64 years: - Bachelor's degree` +
      `Estimate; Female: - 25 to 34 years: - Bachelor's degree` +
      `Estimate; Female: - 35 to 44 years: - Bachelor's degree` +
      `Estimate; Female: - 45 to 64 years: - Bachelor's degree` +
      num_25_64_grad,
    
    num_25_34_assoc_plus = 
      `Estimate; Male: - 25 to 34 years: - Associate's degree` +
      `Estimate; Female: - 25 to 34 years: - Associate's degree` +
      num_25_34_bach_plus,
    
    num_25_64_assoc_plus = 
      `Estimate; Male: - 25 to 34 years: - Associate's degree` +
      `Estimate; Male: - 35 to 44 years: - Associate's degree` +
      `Estimate; Male: - 45 to 64 years: - Associate's degree` +
      `Estimate; Female: - 25 to 34 years: - Associate's degree` +
      `Estimate; Female: - 35 to 44 years: - Associate's degree` +
      `Estimate; Female: - 45 to 64 years: - Associate's degree` +
      num_25_64_bach_plus) %>%
  transmute(
    Id = Id,
    
    per_25_34_assoc_plus = num_25_34_assoc_plus / num_25_34 * 100,
    per_25_64_assoc_plus = num_25_64_assoc_plus / num_25_64 * 100,
    
    per_25_34_bach_plus = num_25_34_bach_plus / num_25_34 * 100,
    per_25_64_bach_plus = num_25_64_bach_plus / num_25_64 * 100,
    
    per_25_34_grad = num_25_34_grad / num_25_34 * 100,
    per_25_64_grad = num_25_64_grad / num_25_64 * 100)

map_data <- degree_map
```

```{r map3}
map_jc@data<-full_join(map_jc@data, degree_map, by = c('GEO_ID' = 'Id'))

make_map("per_25_64_bach_plus", 
         name = "Bachelor Degrees or Higher",
         legend_title = "Bachelor<br/>Degrees")

rm(degree_map)
```


## Change 
Note the axes for these are different. Sorry about that. 
```{r data4}
degree_poverty <- acs_time('/data/education/C17003/', starting_year = 2005)

degree_poverty %<>%
  mutate(
    total_pov = `Estimate; Income in the past 12 months below poverty level:`,
    total_nonpov = `Estimate; Income in the past 12 months at or above poverty level:`,
    
    bach_plus_per_pov = `Estimate; Income in the past 12 months below poverty level: - Bachelor's degree or higher` / total_pov * 100,
      
    bach_plus_per_nonpov = `Estimate; Income in the past 12 months at or above poverty level: - Bachelor's degree or higher` / total_nonpov * 100) %>%
    {
      x <- .
      full_join(
        x %>% weight_stl('bach_plus_per_pov', 'total_pov'),
        x %>% weight_stl('bach_plus_per_nonpov', 'total_nonpov')
      )
    }  %>%
  mutate(bach_plus_pov_gap = bach_plus_per_nonpov - bach_plus_per_pov)

data %<>% bind_df(degree_poverty)

rm(degree_poverty)
```

```{r graph4, fig.width = 10}
graph_trendline_change(data,
                'bach_plus_per_pov',
                plot_title = 'Bachelor Degrees for Adults ages 25 to 64 in Poverty')

graph_trendline(data,
                'bach_plus_per_pov',
                plot_title = 'Bachelor Degrees: in Poverty',
                rollmean = 3)

graph_trendline(data,
                'bach_plus_per_nonpov',
                plot_title = 'Bachelor Degrees: not in Poverty',
                rollmean = 3)

graph_trendline(data,
                'bach_plus_pov_gap',
                plot_title = 'Bachelor Degrees: Gap Between Poverty and Non-Poverty',
                rollmean = 3)

graph_trendline(data,
                'bach_plus_per_pov',
                plot_title = 'Bachelor Degrees: in Poverty')

graph_trendline(data,
                'bach_plus_per_nonpov',
                plot_title = 'Bachelor Degrees: not in Poverty')

```



## Assoc Ranking
```{r graph5}
rank_and_nb_group(data[data$year == 2016,], 
                  'per_25_64_assoc_plus', 
                  plot_title = 'Associate Degrees, Ages 25-64, 2016')
```

## Assoc Trendline
```{r graph6}
graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, assoc_plus_per_white, assoc_plus_per_black, assoc_plus_per_hispanic)%>%
  mutate_at(vars( assoc_plus_per_white, assoc_plus_per_black, assoc_plus_per_hispanic), rollmean3) %>%
  gather(assoc_plus_per_white:assoc_plus_per_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2006,
  xmax = 2015,
  plot_title = "Associate Degrees by Ethnicity",
  subtitle = '3-year rolling average',
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))

graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, assoc_plus_per_white, assoc_plus_per_black, assoc_plus_per_hispanic)%>%
  gather(assoc_plus_per_white:assoc_plus_per_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2005,
  xmax = 2016,
  plot_title = "Associate Degrees by Ethnicity",
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))
```

## Young adult degrees
```{r graph7, fig.width = 10}
graph_trendline(data,
                'per_25_34_bach_plus',
                plot_title = 'Bachelor Degrees, Ages 25-34, 2016',
                rollmean = 3)

graph_trendline(data,
                'per_25_34_assoc_plus',
                plot_title = 'Associate Degrees, Ages 25-34, 2016',
                rollmean = 3)

graph_trendline(data,
                'per_25_34_bach_plus',
                plot_title = 'Bachelor Degrees, Ages 25-34, 2016')

graph_trendline(data,
                'per_25_34_assoc_plus',
                plot_title = 'Associate Degrees, Ages 25-34, 2016')

```

## Education pipeline

Still waiting on private school data
```{r data8}
```

```{r graph8}
```

# Jobs: median earnings {.tabset}
```{r inflation and COL indices}
rpp <- read_csv("data/jobs/rppmsa.csv", skip = 4, col_names = TRUE, na = c("", "(NA)"))

rpp$`2005` <- rpp$`2008`
rpp$`2006` <- rpp$`2008`
rpp$`2007` <- rpp$`2008`
rpp$`2016` <- rpp$`2015`

rpp <- rpp %>%
  filter(LineCode == 4) %>%
  select(-GeoFips, -LineCode, -Description) %>%
  gather(2:13, key = year, value = "rpp") %>%
  mutate(year = as.numeric(year))

rpp$MSA <- substr(rpp$GeoName, 0, unlist(gregexpr(pattern = " \\(", rpp$GeoName)) -1 )

rpp$MSA[rpp$MSA == "Grand Rapids-Wyoming, MI"] = "Grand Rapids"
rpp$MSA[rpp$MSA == "St. Louis, MO-IL"] = "St. Louis"
rpp$MSA[rpp$MSA == "Oklahoma City, OK"] = "Oklahoma City"
rpp$MSA[rpp$MSA == "Tulsa, OK"] = "Tulsa"
rpp$MSA[rpp$MSA == "Greenville-Anderson-Mauldin, SC"] = "Greenville"
rpp$MSA[rpp$MSA == "Knoxville, TN"] = "Knoxville"
rpp$MSA[rpp$MSA == "Birmingham-Hoover, AL"] = "Birmingham"
rpp$MSA[rpp$MSA == "Louisville/Jefferson County, KY-IN"] = "Louisville"
rpp$MSA[rpp$MSA == "Indianapolis-Carmel-Anderson, IN"] = "Indianapolis"
rpp$MSA[rpp$MSA == "Kansas City, MO-KS"] = "Kansas City"
rpp$MSA[rpp$MSA == "Omaha-Council Bluffs, NE-IA"] = "Omaha"
rpp$MSA[rpp$MSA == "Greensboro-High Point, NC"] = "Greensboro"
rpp$MSA[rpp$MSA == "Charlotte-Concord-Gastonia, NC-SC"] = "Charlotte"
rpp$MSA[rpp$MSA == "Columbus, OH"] = "Columbus"
rpp$MSA[rpp$MSA == "Cincinnati, OH-KY-IN"] = "Cincinnati"
rpp$MSA[rpp$MSA == "Nashville-Davidson--Murfreesboro--Franklin, TN"] = "Nashville"
rpp$MSA[rpp$MSA == "Memphis, TN-MS-AR"] = "Memphis"
rpp$MSA[rpp$MSA == "Jacksonville, FL"] = "Jacksonville"
rpp$MSA[rpp$MSA == "Raleigh, NC"] = "Raleigh"
rpp$MSA[rpp$MSA == "Dayton, OH"] = "Dayton"
rpp$MSA[rpp$MSA == "Richmond, VA"] = "Richmond"

rpp %<>% select(-GeoName)

data %<>% left_join(rpp, by = c('year' = 'year', 'city' = 'MSA'))

data %<>%
  group_by(year) %>%
  mutate(rpp_lou = rpp[city == "Louisville"],
         rpp_index = rpp_lou / rpp) %>%
  ungroup() %>%
  select(-rpp, -rpp_lou)

cpi <- read_csv("data/jobs/CPI-U-RS.csv")

cpi %<>%
  rename(year = YEAR,
         cpi = AVG)

data %<>% left_join(cpi, by = "year")

data %<>%
  group_by(city) %>%
  mutate(base_cpi = cpi[year == 2016],
         cpi_index = base_cpi/cpi) %>%
  ungroup() %>%
  select(-cpi, -base_cpi)

rm(rpp, cpi)
```

## Ranking
```{r data9}
earn_data <- acs_time("/data/jobs/S2001/")

earn_data <- earn_data %>%
  select(FIPS, 
         year,
         median_earnings = `Total; Estimate; Population 16 years and over with earnings - Median earnings (dollars)`) %>%
  mutate(median_earnings = as.numeric(as.character(median_earnings)),
         FIPS = as.character(FIPS)) %>%
  weight_stl('median_earnings')

data %<>% bind_df(earn_data) %>%
  mutate(median_earnings = median_earnings * rpp_index * cpi_index)

rm(earn_data)
```

```{r graph9}
rank_and_nb_group(df = data[data$year == 2016,], 
                  var = 'median_earnings', 
                  plot_title = 'Median Earnings, 2016')
```

## Trendline by race
```{r data10}
earn_data_white <- acs_time("/data/jobs/B20017H/")

earn_data_white <- earn_data_white %>%
  select(FIPS, 
         year,
         median_earnings_white = `Estimate; Total:`) %>%
  mutate(FIPS = as.character(FIPS),
         median_earnings_white = as.numeric(as.character(median_earnings_white))) %>%
  weight_stl('median_earnings_white')

earn_data_black <- acs_time("/data/jobs/B20017B/")

earn_data_black <- earn_data_black %>%
  select(FIPS, 
         year,
         median_earnings_black = `Estimate; Total:`) %>%
  mutate(FIPS = as.character(FIPS),
         median_earnings_black = as.numeric(as.character(median_earnings_black))) %>%
  weight_stl('median_earnings_black')

earn_data_hisp <- acs_time("/data/jobs/B20017I/")

earn_data_hisp <- earn_data_hisp %>%
  select(FIPS, 
         year,
         median_earnings_hispanic = `Estimate; Total:`) %>%
  mutate(FIPS = as.character(FIPS),
         median_earnings_hispanic = as.numeric(as.character(median_earnings_hispanic))) %>%
  weight_stl('median_earnings_hispanic')

data %<>% bind_df(earn_data_white, earn_data_black, earn_data_hisp) %>%
  mutate_at(vars(median_earnings_white, median_earnings_black, median_earnings_hispanic), rpp_col_adj)

rm(earn_data_white, earn_data_black, earn_data_hisp)
```

```{r graph10}
graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, median_earnings_white, median_earnings_black, median_earnings_hispanic)%>%
  gather(median_earnings_white:median_earnings_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2005,
  xmax = 2016,
  plot_title = "Earnings by Ethnicity",
  labels = c("African American", "Hispanic", "White"),
  y_title = "Dollars",
  color_pal = wes_palette("Moonrise2"))

graph_trendline_race_peer(data, 
                          vars = c('median_earnings_white', 'median_earnings_black', 'median_earnings_hispanic'),
                          plot_title = 'Median Earnings by Ethnicity',
                          rollmean = 3,
                          y_title = 'Dollars')

graph_trendline_race_peer(data, 
                          vars = c('median_earnings_white', 'median_earnings_black', 'median_earnings_hispanic'),
                          plot_title = 'Median Earnings by Ethnicity',
                          rollmean = 1,
                          y_title = 'Dollars')

```

## Map
```{r data11}
earn_map <- read_csv("data/jobs/ACS_16_5YR_S2001_with_ann.csv", skip = 1,
                      col_types = cols(
                      `Total; Estimate; Median earnings (dollars)` = col_number())
                   ) 

earn_map %<>% select(Id, median_earnings = `Total; Estimate; Median earnings (dollars)`)
```

```{r graph11}
map_jc@data <- full_join(map_jc@data, earn_map, by = c('GEO_ID' = 'Id'))

make_map("median_earnings", 
         name = "Median Earnings",
         legend_title = "Median<br/>Earnings",
         units = "Dollars")

rm(earn_map)
```
## change: high wage jobs
```{r data12}
```
```{r graph12}
```


## Earnings gap
```{r data13}
data %<>%
  mutate(earnings_gap_black = median_earnings_white - median_earnings_black,
         earnings_gap_hispanic = median_earnings_white - median_earnings_hispanic)
```

```{r graph13, fig.width = 10}
graph_trendline(data,
                'earnings_gap_black',
                plot_title = 'Earnings Gap Between Black and White Residents',
                y_title = "Dollars",
                rollmean = 5)

graph_trendline(data,
                'earnings_gap_hispanic',
                plot_title = 'Earnings Gap Between Hispanic and White Residents',
                y_title = "Dollars",
                rollmean = 5)

graph_trendline(data,
                'earnings_gap_black',
                plot_title = 'Earnings Gap Between Black and White Residents',
                y_title = "Dollars")

graph_trendline(data,
                'earnings_gap_hispanic',
                plot_title = 'Earnings Gap Between Hispanic and White Residents',
                y_title = "Dollars")
```


## Jobs by zip code
```{r data14}
business_data <- read_csv('data/jobs/BP_2016_00CZ1_with_ann.csv', skip = 1)

#Join to Louisville Zip codes
zip_codes <- read_csv('data/jobs/zcta_county_rel_10.csv')

zip_codes %<>% 
  filter(GEOID == 21111) %>%
  select(zip = ZCTA5,
         pop = ZPOP)

zip_codes$pop <- replace(zip_codes$pop, zip_codes$pop < 500, NA)
zip_codes$pop[zip_codes$zip == 40202] <- NA

business_data <- zip_codes %>% 
  left_join(business_data, by = c('zip' = 'Id2'))

business_data <- business_data[,c(1, 2, 8, 9, 11)]

business_data %<>%
  mutate(businesses = `Number of establishments`,
         employees  = as.numeric(`Paid employees for pay period including March 12 (number)`),
         payroll    = as.numeric(`Annual payroll ($1,000)`) * 1000) %>%
  mutate(businesses_per_resident = businesses / pop,
         jobs_per_resident = employees / pop,
         payroll_per_resident = payroll / pop,
         payroll_per_job = payroll / employees) %>%
  select(zip,
         businesses_per_resident, jobs_per_resident, payroll_per_resident, payroll_per_job)

map_data_zip <- business_data

rm(zip_codes, business_data)

#a = 0-19
#e = 250-499
#g = 1,000 to 2,499
```

```{r graph14}
map_jc_zip@data <- full_join(map_jc_zip@data, map_data_zip, by = c('ZIPCODE' = 'zip'))
```

I removed some zip codes with very low population to avod skewing the numbers. I also removed downtown because it is so diffferent from everywhere else in the county: if it is included, the rest of the map is white.

**Businesses per resident**
```{r graph14.1}
make_map_zip("businesses_per_resident", 
             name = "Businesses per Resident",
             legend_title = "Businesses<br/>per res",
             units = "none")
```

**Jobs per resident**
```{r graph14.2}
make_map_zip("jobs_per_resident", 
             name = "Jobs per Resident",
             legend_title = "Jobs<br/>per res",
             units = "none")
```

**Payroll per resident**
```{r graph14.3}
make_map_zip("payroll_per_resident", 
             name = "Payroll per Resident",
             legend_title = "Payroll<br/>per res",
             units = "Dollars")
```

**Payroll per worker**
```{r graph14.4}
make_map_zip("payroll_per_job", 
             name = "Payroll per Worker",
             legend_title = "Payroll<br/>per worker",
             units = "Dollars")
```

## Unemployment trendline by race
```{r data15}
#White
unemp_white <- acs_time("/data/jobs/B23002H/", starting_year = 2005)

unemp_white %<>%
  mutate(
    total = 
      `Estimate; Male: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 65 to 69 years: - In labor force:` +
      `Estimate; Male: - 70 years and over: - In labor force:` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 65 to 69 years: - In labor force:` +
      `Estimate; Female: - 70 years and over: - In labor force:`,
    
    unemp_white = 
      (`Estimate; Male: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Male: - 70 years and over: - In labor force: - Unemployed` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Female: - 70 years and over: - In labor force: - Unemployed`)
      / total * 100) %>%
  weight_stl('unemp_white', 'total')

#Black
unemp_black <- acs_time("/data/jobs/B23002B/", starting_year = 2005)

unemp_black %<>%
  mutate(
    total = 
      `Estimate; Male: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 65 to 69 years: - In labor force:` +
      `Estimate; Male: - 70 years and over: - In labor force:` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 65 to 69 years: - In labor force:` +
      `Estimate; Female: - 70 years and over: - In labor force:`,
    
    unemp_black = 
      (`Estimate; Male: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Male: - 70 years and over: - In labor force: - Unemployed` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Female: - 70 years and over: - In labor force: - Unemployed`)
      / total * 100) %>%
  weight_stl('unemp_black', 'total')

#Hispanic
unemp_hisp <- acs_time("/data/jobs/B23002I/", starting_year = 2005)

unemp_hisp %<>%
  mutate(
    total = 
      `Estimate; Male: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Male: - 65 to 69 years: - In labor force:` +
      `Estimate; Male: - 70 years and over: - In labor force:` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian:` +
      `Estimate; Female: - 65 to 69 years: - In labor force:` +
      `Estimate; Female: - 70 years and over: - In labor force:`,
    
    unemp_hisp = 
      (`Estimate; Male: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Male: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Male: - 70 years and over: - In labor force: - Unemployed` +
      `Estimate; Female: - 16 to 19 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 20 to 24 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 25 to 54 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 55 to 64 years: - In labor force: - Civilian: - Unemployed` +
      `Estimate; Female: - 65 to 69 years: - In labor force: - Unemployed` + 
      `Estimate; Female: - 70 years and over: - In labor force: - Unemployed`)
      / total * 100) %>%
  weight_stl('unemp_hisp', 'total')

data %<>% bind_df(unemp_white, unemp_black, unemp_hisp)

rm(unemp_white, unemp_black, unemp_hisp)

```

The survey size is too small to include Hispanic residents. I can get ahold of 3- or 5- year estimates, but it will take me a while.
```{r graph15}
graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, unemp_white, unemp_black, unemp_hisp)%>%
  gather(unemp_white:unemp_hisp, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2005,
  xmax = 2016,
  plot_title = "Unemployment by Ethnicity",
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))
```


### Working poverty

### Income inequality

# Health: health outcomes index {.tabset}

## Ranking
```{r data16.1, eval = FALSE}
setwd("data/health/natality")

natality <- wonder_time("2003-2006", "FIPS")
natality <- rbind(natality, wonder_time("2007-2016", "FIPS"))

natality <- natality %>%
  select(year = Year, weight = `Birth Weight 12 Code`, births = Births, FIPS) %>%
  mutate(weight = as.numeric(weight), births = as.numeric(births), FIPS = as.numeric(FIPS))

natality$underweight <- if_else(natality$weight <= 5, 1, 0)

natality <- natality %>%
  group_by(FIPS, year, underweight) %>%
  summarise(babies = sum(births, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(pct_underweight = babies / sum(babies),
         FIPS = as.character(FIPS)) %>%
  filter(underweight == 1) %>%
  select(-underweight)

natality <-  natality %>%  pull_peers_FIPS()
```

```{r data16.2, eval = FALSE}
#one-year mortality data
mortality_one <- wonder_time("data/health/mortality/one-year", "MSA")

mortality_one <- mortality_one %>%
  select(year = Year, age = `Single-Year Ages Code`, deaths = Deaths, population = Population, MSA) %>%
  mutate(age = as.numeric(age), deaths = as.numeric(deaths), population = as.numeric(population), MSA = as.numeric(MSA)) %>%
  filter(age < 75)

#Add ten-year death counts
mortality_ten <- wonder_time("data/health/mortality/ten-year", "MSA")

mortality_ten <- mortality_ten %>%
  select(year = Year, age = `Ten-Year Age Groups Code`, deaths = Deaths, MSA) %>%
  separate(age, c("bottom", "top")) %>%
  filter(bottom != "NS") %>%
  mutate_at(vars(bottom, top, deaths, MSA), funs(as.numeric))

mortality_ten[mortality_ten$bottom == 1 & is.na(mortality_ten$top),"bottom"] <- 0
mortality_ten[mortality_ten$bottom == 0 & is.na(mortality_ten$top),"top"] <- 0

mortality_ten <- mortality_ten %>%
  filter(bottom < 75) %>%
  {
    x = .
    bind_rows(
      x %>%
        filter(bottom == 0) %>%
        mutate(dif = 1),
      x %>%
        filter(bottom > 0) %>%
        mutate(dif = top - bottom + 1)
    )
  } %>%
  mutate(deaths_per_year = deaths / dif)

mortality <- mortality_one

mortality_ten <- mortality_ten[rep(seq(nrow(mortality_ten)), mortality_ten$dif),]

mortality_ten <- mortality_ten %>%
  group_by(year, MSA, bottom) %>%
  mutate(age = bottom + seq_along(dif) - 1) %>%
  ungroup() %>%
  select(year, age, MSA, deaths_per_year) %>%
  rename(deaths = deaths_per_year)

#combine datasets
mortality <- mortality %>%
 {
    x = .
    bind_rows(
      x %>%
        filter(is.na(deaths)) %>%
        select(-deaths) %>%
        left_join(mortality_ten, by = c('year', 'age', 'MSA')),
      x %>%
        filter(!is.na(deaths))
    )
 }

#Adjust to US 2000 standard population
std_pop <- read_table('C:/Users/Harrison Kirby/Desktop/GLP/ccu18/data/health/stdpop.singleagesthru84.txt',
                      col_names = FALSE)

std_pop %<>%
  transmute(geography = str_sub(X1, 1, 3),
            age = str_sub(X1, 4, 6),
            pop = str_sub(X1, 7)) %>%
  mutate_all(as.numeric) %>%
  filter(geography == 202 & age < 75) %>%
  mutate(age_pct_std = pop / sum(pop)) %>%
  select(age, age_pct_std)

mortality %<>%
  left_join(std_pop) %>%
  group_by(MSA, year) %>%
  mutate(age_pct = population / sum(population)) %>%
  mutate(population = population * age_pct_std / age_pct,
         deaths = deaths * age_pct_std / age_pct) %>% 
  ungroup()

#YPLL Calculation

mortality <- mortality %>%
  mutate(years_lost = 75 - age, 
         year_loss = years_lost * deaths)

mortality <- mortality %>%
  group_by(year, MSA) %>%
  mutate(total_population = sum(population, na.rm = TRUE)) %>%
  filter(age < 75) %>%
  mutate(total_ypll = sum(year_loss, na.rm = TRUE),
         ypll = total_ypll / (total_population / 100000)) %>%
  ungroup() %>%
  filter(age == 0) %>%
  select(MSA, year, ypll)
```

```{r data16.3, eval = FALSE}
brfss <- read_feather("data/health/brfss.feather")

brfss <- brfss %>% rename(MSA = msa) %>% pull_peers_MSA()

#recode data
brfss$age[brfss$year >= 2003] <- plyr::mapvalues(brfss$age[brfss$year >= 2011], 1:6, c(1, 1, 1, 2, 2, 3))

brfss$poor_or_fair <- if_else(brfss$hlth == 4 | brfss$hlth == 5, 1, 0)
brfss$poor_or_fair[brfss$hlth == 7 | brfss$hlth == 9] <- NA

brfss$physdays[brfss$physdays == 77 | brfss$physdays == 99] <- NA
brfss$physdays[brfss$physdays == 88] <- 0

brfss$mentdays[brfss$mentdays == 77 | brfss$mentdays == 99] <- NA
brfss$mentdays[brfss$mentdays == 88] <- 0

brfss <- brfss %>% filter(year > 2003)

#create survey objects
brfss_svy <- svydesign(ids = ~0, weights = ~wgt, data = brfss)
pop_age <- c(0.530534557, 0.299194019, 0.170271424)

brfss_svy_std <- svystandardize(brfss_svy, by = ~age, over = ~MSA+year, population = pop_age, excluding.missing = ~poor_or_fair+physdays+mentdays)

brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy_std, svymean, na.rm = TRUE) %>%
  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results$city<-NA
brfss_results$city[brfss_results$MSA == 24340] = "Grand Rapids"
brfss_results$city[brfss_results$MSA == 41180] = "St. Louis"
brfss_results$city[brfss_results$MSA == 36420] = "Oklahoma City"
brfss_results$city[brfss_results$MSA == 46140] = "Tulsa"
brfss_results$city[brfss_results$MSA == 24860] = "Greenville"
brfss_results$city[brfss_results$MSA == 28940] = "Knoxville"
brfss_results$city[brfss_results$MSA == 13820] = "Birmingham"
brfss_results$city[brfss_results$MSA == 31140] = "Louisville"
brfss_results$city[brfss_results$MSA == 26900] = "Indianapolis"
brfss_results$city[brfss_results$MSA == 28140] = "Kansas City"
brfss_results$city[brfss_results$MSA == 36540] = "Omaha"
brfss_results$city[brfss_results$MSA == 24660] = "Greensboro"
brfss_results$city[brfss_results$MSA == 16740] = "Charlotte"
brfss_results$city[brfss_results$MSA == 18140] = "Columbus"
brfss_results$city[brfss_results$MSA == 17140] = "Cincinnati"
brfss_results$city[brfss_results$MSA == 34980] = "Nashville"
brfss_results$city[brfss_results$MSA == 32820] = "Memphis"
brfss_results$city[brfss_results$MSA == 27260] = "Jacksonville"
brfss_results$city[brfss_results$MSA == 39580] = "Raleigh"
brfss_results$city[brfss_results$MSA == 19380] = "Dayton"
brfss_results$city[brfss_results$MSA == 40060] = "Richmond"

g_2015 <- brfss_results[brfss_results$city == "Greensboro" & brfss_results$year == 2014, 1:6]
g_2015$year <- 2015

brfss_results <- rbind(brfss_results, g_2015)

g_2015$year <- 2016
brfss_results <- rbind(brfss_results, g_2015)

msa_fips <- read_csv('data/MSA to FIPS.csv') %>% select(-city) %>% mutate(FIPS = as.character(FIPS))

natality <- left_join(natality, msa_fips)

#Create index
health_index <- full_join(mortality, natality, by = c("MSA", "year"))
health_index <- full_join(health_index, brfss_results, by = c("MSA", "year"))

health_index <- health_index %>%
  filter(current == 1) %>%
  select(FIPS, year, ypll, pct_underweight, poor_or_fair, physdays, mentdays) %>%
  filter(year > 2003)

# give St. Louis a new FIPS
health_index$FIPS[health_index$FIPS == 29189] <- "MERGED"

#Create index
norm_z <- function(x){
z <- (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}

health_z <- health_index
health_z <- map_df(health_z, remove_var_label)

health_z <- health_z %>%
  group_by(year) %>%
  mutate(ypll_index = norm_z(ypll),
         pct_underweight_index = norm_z(pct_underweight),
         poor_or_fair_index = norm_z(poor_or_fair),
         physdays_index = norm_z(physdays),
         mentdays_index = norm_z(mentdays)) %>%
  ungroup()

health_z <- health_z %>%
  mutate(
    health_index = 
      ypll_index*.5+
      pct_underweight_index*.2+
      poor_or_fair_index*.1+
      physdays_index*.1+
      mentdays_index*.1)

data %<>% bind_df(health_z)

rm(brfss, brfss_results, brfss_svy, brfss_svy_std, health_index, health_z, mortality, mortality_age, mortality_one, mortality_ten, std_pop, natality, g_2015, msa_fips)
```

```{r graph16, eval = FALSE}
rank_and_nb_group(data[data$year == 2016,],
                  'health_index',
                  plot_title = 'Health Outcomes Index',
                  order = "Ascending")
```

## Trendline by race
```{r data17}

```

```{r graph17}

```
## Map of life expectancy

![](life_expectancy.png)

```{r data18}

```

```{r graph18}

```
## Change; % of children in poverty
```{r data19}
ch_pov <- read_csv('C:/Users/Harrison Kirby/Desktop/GLP/glp_website/output data/education_data_fips.csv')
```

```{r graph19}
graph_trendline_change(ch_pov,
                       'child_per',
                       'Child Poverty')
```

## Health insurance by race
```{r data20}
insurance_white <- acs_time("/data/health/C27001H/", starting_year = 2009)

insurance_white %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_white =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100) %>%
  weight_stl('uninsurance_rate_white', 'total') 

insurance_black <- acs_time("/data/health/C27001B/", starting_year = 2009)

insurance_black %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_black =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100) %>%
  weight_stl('uninsurance_rate_black', 'total') 

insurance_hisp <- acs_time("/data/health/C27001I/", starting_year = 2009)

insurance_hisp %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_hispanic =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100) %>%
  weight_stl('uninsurance_rate_hispanic', 'total') 

data %<>% bind_df(insurance_white, insurance_black, insurance_hisp)

rm(insurance_white, insurance_black, insurance_hisp)
```

```{r graph 20}
graph_df <- data %>%
filter(FIPS == 21111)%>%
  select(year, uninsurance_rate_white, uninsurance_rate_black, uninsurance_rate_hispanic) %>%
  gather(uninsurance_rate_white:uninsurance_rate_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2009,
  xmax = 2016,
  plot_title = "Bachelor Degrees by Ethnicity",
  subtitle_text = '3-year rolling average',
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))

graph_trendline_race_peer(data, 
                          vars = c('uninsurance_rate_white', 'uninsurance_rate_black', 'uninsurance_rate_hispanic'),
                          xmin = 2009,
                          plot_title = 'Uninsurance by Ethnicity')
```

## Health insurance by income quartiles (demonstrate impact of expanded Medicaid)

```{r data21}
uninsured_income_09 <- acs_time('/data/health/B27016/Y09/', starting_year = 2009)

uninsured_income_09 %<>%
  mutate(
    insured_per_0.5_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; Under 0.50 of poverty threshold:`,
    
    insured_per_0.5_to_.99_pov = 
      (`Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 0.50 to .99 of poverty threshold:`,
    
    insured_per_1_to_1.49_pov = 
      (`Estimate; 1.00 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.00 to 1.49 of poverty threshold:`,
    
    insured_per_1.5_to_1.99_pov = 
      (`Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.50 to 1.99 of poverty threshold:`,
    
    insured_per_2_to_2.99_pov = 
      (`Estimate; 2.00 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.00 to 2.99 of poverty threshold:`,
    
    insured_per_3_to_3.99_pov = 
      (`Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 3.00 to 3.99 of poverty threshold:`,
    
    insured_per_4_plus_pov = 
      (`Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 4.00 of poverty threshold and over:`) %>%
  weight_stl(c('insured_per_0.5_pov', 'insured_per_0.5_to_.99_pov', 'insured_per_1_to_1.49_pov', 'insured_per_1.5_to_1.99_pov', 
               'insured_per_2_to_2.99_pov', 'insured_per_3_to_3.99_pov', 'insured_per_4_plus_pov')) %>%
  mutate(insured_per_2_to_2.49_pov = NA,
         insured_per_2.5_to_2.99_pov = NA,
         insured_per_1_to_1.37_pov = NA,
         insured_per_1.38_1.49_pov = NA)

uninsured_income_11 <- acs_time('/data/health/B27016/Y11/', starting_year = 2011)

uninsured_income_11 %<>%
  mutate(
    insured_per_0.5_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; Under 0.50 of poverty threshold:`,
    
    insured_per_0.5_to_.99_pov = 
      (`Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 0.50 to .99 of poverty threshold:`,
    
    insured_per_1_to_1.37_pov =
      (`Estimate; 1.00 to 1.37 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.00 to 1.37 of poverty threshold:`,

    insured_per_1.38_1.49_pov =
      (`Estimate; 1.38 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.38 to 1.49 of poverty threshold:`,
    
    insured_per_1_to_1.49_pov = 
      (`Estimate; 1.00 to 1.37 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      / (`Estimate; 1.00 to 1.37 of poverty threshold:` + `Estimate; 1.38 to 1.49 of poverty threshold:`),
    
    insured_per_1.5_to_1.99_pov = 
      (`Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.50 to 1.99 of poverty threshold:`,
    
    insured_per_2_to_2.49_pov =
      (`Estimate; 2.00 to 2.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.00 to 2.49 of poverty threshold:`,

    insured_per_2.5_to_2.99_pov =
      (`Estimate; 2.50 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.50 to 2.99 of poverty threshold:`,

    insured_per_2_to_2.99_pov = 
      (`Estimate; 2.00 to 2.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      / (`Estimate; 2.00 to 2.49 of poverty threshold:` + `Estimate; 2.50 to 2.99 of poverty threshold:`),
    
    insured_per_3_to_3.99_pov =
      (`Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 3.00 to 3.99 of poverty threshold:`, 

    insured_per_4_plus_pov = 
      (`Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 4.00 of poverty threshold and over:`) %>%
  weight_stl(c('insured_per_0.5_pov', 'insured_per_0.5_to_.99_pov', 'insured_per_1_to_1.37_pov', 'insured_per_1.38_1.49_pov',
               'insured_per_1_to_1.49_pov', 'insured_per_1.5_to_1.99_pov', 'insured_per_2_to_2.49_pov','insured_per_2.5_to_2.99_pov',
               'insured_per_2_to_2.99_pov', 'insured_per_3_to_3.99_pov', 'insured_per_4_plus_pov'))

uninsured_income <- bind_rows(uninsured_income_09, uninsured_income_11)

data %<>% bind_df(uninsured)

rm(uninsured_income_09, uninsured_income_11, uninsured_incone)

```

```{r graph21}
uninsured_graph <- uninsured_income %>% 
  gather(insured_per_0.5_pov:insured_per_1.38_1.49_pov, key = 'key', value = 'value') %>%
  filter(FIPS == 21111) #change to data

ggplotly(ggplot(uninsured_graph, aes(x = year, y = value, color = key)) + 
  geom_line())

```
# QOP {.tabset}

## Ranking: homeownership
```{r data22}
tenure <- acs_time('/data/qop/B25003/')

tenure %<>%
  mutate(
    total = `Estimate; Total:`,
    homeownership = `Estimate; Owner occupied` / total * 100) %>%
  weight_stl('homeownership', 'total')

data %<>% bind_df(tenure)

rm(tenure)
```

```{r graph22}
rank_and_nb_group(data[data$year == 2016,],
                  'homeownership', 
                  plot_title = 'Homeownership, 2016')
```

## Trendline: homeownership by race
```{r data23}
tenure_white <- acs_time('/data/qop/B25003H/')

tenure_white %<>%
  mutate(
    total = `Estimate; Total:`,
    homeownership_white = `Estimate; Owner occupied` / total * 100) %>%
  weight_stl('homeownership_white', 'total')

tenure_black <- acs_time('/data/qop/B25003B/')

tenure_black %<>%
  mutate(
    total = `Estimate; Total:`,
    homeownership_black = `Estimate; Owner occupied` / total * 100) %>%
  weight_stl('homeownership_black', 'total')

tenure_hisp <- acs_time('/data/qop/B25003I/')

tenure_hisp %<>%
  mutate(
    total = `Estimate; Total:`,
    homeownership_hispanic = `Estimate; Owner occupied` / total * 100) %>%
  weight_stl('homeownership_hispanic', 'total')

data %<>% bind_df(tenure_white, tenure_black, tenure_hisp)

data %<>% mutate(homeownership_gap_black = homeownership_white - homeownership_black)
                  
rm(tenure_white, tenure_black, tenure_hisp)
```

```{r graph23}
graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, homeownership_white, homeownership_black, homeownership_hispanic)%>%
  mutate_at(c('homeownership_white', 'homeownership_black', 'homeownership_hispanic'), rollmean3) %>%
  gather(homeownership_white:homeownership_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2006,
  xmax = 2015,
  plot_title = "Homeownership by Ethnicity",
  subtitle_text = '3-year rolling average',
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))

graph_df <- data %>%
  filter(FIPS == 21111)%>%
  select(year, homeownership_white, homeownership_black, homeownership_hispanic)%>%
  gather(homeownership_white:homeownership_hispanic, 
         key = "var", value = "value")%>%
  arrange(var)

graph_df$var <- factor(graph_df$var, levels = unique(graph_df$var))

graph_trendline_race(
  graph_df,
  xmin = 2005,
  xmax = 2016,
  plot_title = "Homeownership by Ethnicity",
  labels = c("African American", "Hispanic", "White"),
  y_title = "Percent",
  color_pal = wes_palette("Moonrise2"))

graph_trendline(data, 
                'homeownership_gap_black', 
                plot_title = 'Homeownership Gap between Black and White Residents',
                rollmean = 3)

graph_trendline_race_peer(data, 
                          vars = c('homeownership_white', 'homeownership_black', 'homeownership_hispanic'),
                          plot_title = 'Homeownership by Ethnicity',
                          rollmean = 3)
```
## Map: homeownership or burdened households
```{r data24}
tenure_map <- read_csv('data/qop/ACS_16_5YR_B25003_with_ann.csv', skip = 1)

tenure_map %<>%
  mutate(
    homeownership = `Estimate; Total: - Owner occupied` / `Estimate; Total:` * 100) %>%
  select(Id, homeownership)


burdened_map <- read_csv('data/qop/ACS_16_5YR_B25106_with_ann.csv', skip = 1)

burdened_map %<>%
  mutate(
    burdened = 
      (`Estimate; Owner-occupied housing units: - Less than $20,000: - 30 percent or more` + 
      `Estimate; Owner-occupied housing units: - $20,000 to $34,999: - 30 percent or more` +
      `Estimate; Owner-occupied housing units: - $35,000 to $49,999: - 30 percent or more` +       
      `Estimate; Owner-occupied housing units: - $50,000 to $74,999: - 30 percent or more` +       
      `Estimate; Owner-occupied housing units: - $75,000 or more: - 30 percent or more` +
      `Estimate; Owner-occupied housing units: - Zero or negative income` +
      `Estimate; Renter-occupied housing units: - Less than $20,000: - 30 percent or more` +        
      `Estimate; Renter-occupied housing units: - $20,000 to $34,999: - 30 percent or more` +     
      `Estimate; Renter-occupied housing units: - $35,000 to $49,999: - 30 percent or more` +   
      `Estimate; Renter-occupied housing units: - $50,000 to $74,999: - 30 percent or more` +    
      `Estimate; Renter-occupied housing units: - $75,000 or more: - 30 percent or more` +
      `Estimate; Renter-occupied housing units: - Zero or negative income`)
      / `Estimate; Total:` * 100) %>%
  select(Id, burdened)

map_data %<>% full_join(tenure_map)
map_data %<>% full_join(burdened_map)
```

Homeownership
```{r graph24}
map_jc@data <- full_join(map_jc@data, tenure_map, by = c('GEO_ID' = 'Id'))
map_jc@data <- full_join(map_jc@data, burdened_map, by = c('GEO_ID' = 'Id'))
```
```{r graph24.1}
make_map("homeownership", 
         name = "Homeownership",
         legend_title = "Homeownership",
         units = "Percent")
```

Burdened Households
```{r graph24.2}
make_map("burdened", 
         name = "Burdened Households",
         legend_title = "Burdened Households",
         units = "Percent")

rm(tenure_map, burdened_map)
```
## change: home values by areas
```{r data25, warning=TRUE}
map_data %<>% mutate(tract = str_sub(Id, start = 10))

HPI <- read_feather('data/qop/HPI_AT_BDL_ZIP5.feather')

HPI %<>%
  rename(
    zip = `Five-Digit ZIP Code`,
    year = Year,
    annual_change = `Annual Change (%)`) %>%
  mutate(
    zip = as.numeric(zip),
    annual_change = replace(annual_change, annual_change == '.', NA),
    annual_change = as.numeric(annual_change)) %>%
  select(zip, year, annual_change) %>%
  group_by(zip) %>%
  mutate(avg_change = mean(annual_change, na.rm = TRUE),
         avg_change5 = rollmean5(annual_change)) %>%
  filter(year > 1999) %>%
  mutate(avg_change_2000 = mean(annual_change, na.rm = TRUE)) %>%
  ungroup()

HPI_2015 <- HPI %>% filter(year == 2015) %>% select(zip, avg_change5)
HPI_2017 <- HPI %>% filter(year == 2017) %>% select(zip, annual_change, avg_change_2000)

map_jc_zip@data %<>% left_join(HPI_2015, by = c('ZIPCODE' = 'zip'))
map_jc_zip@data %<>% left_join(HPI_2017, by = c('ZIPCODE' = 'zip'))

rm(HPI, HPI_2015, HPU_2017)
```

Change in Housing Prices, 2017
```{r graph25.1}
make_map_zip("annual_change", 
             name = "Average Home Price Increase",
             legend_title = "Average<br>Home Price<br>Increase",
             units = "Percent")
```

Change in Housing Prices, 2013-2017
```{r graph25.2}
make_map_zip("avg_change5", 
             name = "Average Home Price Increase",
             legend_title = "Average<br>Home Price<br>Increase",
             units = "Percent")
```

Change in housing prices, 2000-2017
```{r graph25.3}
make_map_zip("avg_change5", 
             name = "Average Home Price Increase",
             legend_title = "Average<br>Home Price<br>Increase",
             units = "Percent")
```

## % of MSA in core county
```{r data26}
#Read in data
fips_core_county_pop <- read_csv("data/population_data_one_stl.csv")
  
#Create "key" for core FIPS county to MSA
msa_fips_key <- read_csv("data/msa_to_fips.csv")

msa_fips_key %<>% 
  mutate(FIPS = as.character(FIPS)) %>%
  pull_peers_FIPS()

msa_fips_key$FIPS[msa_fips_key$MSA == 41180]<- "MERGED"

#Add MSA code
fips_core_county_pop %<>% left_join(msa_fips_key, by = "FIPS")
fips_core_county_pop %<>% filter(year >= 2010)

#Tidy MSA Population estimate Data
msa_pop_est <- read_csv("data/qop/cbsa-est2016-alldata.csv", n_max = 1581)
msa_pop_est %<>% filter(LSAD == "Metropolitan Statistical Area") %>%
  mutate(MSA = CBSA) %>%
  pull_peers_MSA() %>%
  select(MSA, POPESTIMATE2010:POPESTIMATE2015) %>%
  gather(POPESTIMATE2010:POPESTIMATE2015, key = 'year',value = population_estimate)

msa_pop_est$year = substr(msa_pop_est$year, 12,15)
msa_pop_est$year = as.numeric(msa_pop_est$year)

#Combine datasets and create core county pct estimates
fips_core_county_pop %<>% left_join(msa_pop_est, by = c("MSA", "year"))

fips_core_county_pop %<>% 
  mutate(pct_pop_core_county = 100 * population / population_estimate) %>%
  rename(core_county_pop = population,
         msa_population_estimate = population_estimate) %>%
  select(FIPS, year, pct_pop_core_county)

data %<>% bind_df(fips_core_county_pop)

rm(fips_core_county_pop, msa_fips_key, msa_pop_est)
```

```{r graph26}
graph_trendline(data,
                'pct_pop_core_county',
                plot_title = 'Percent of the population living in the Core County',
                xmin = 2010,
                xmax = 2015)
```
## Housing stock $ by race
```{r data27}

```

```{r graph27}

```
## Segregation = % race by % area
```{r data28}
seg_data <- read_csv('data/qop/ACS_16_5YR_B03002_with_ann.csv', skip = 1)

seg_data %<>%
  transmute(
    total = `Estimate; Total:`,
    
    pct_of_all_residents = total / sum(total) * 100,
    
    pct_black_tract = `Estimate; Not Hispanic or Latino: - Black or African American alone` / total * 100,
    
    pct_of_all_black_residents = 
      `Estimate; Not Hispanic or Latino: - Black or African American alone` / 
      sum(`Estimate; Not Hispanic or Latino: - Black or African American alone`) * 100) %>%
  mutate(
    pct_of_all_residents = round(pct_of_all_residents, 1),
    pct_black_tract = round(pct_black_tract, 1),
    pct_of_all_black_residents = round(pct_of_all_black_residents, 1)) %>%
  arrange(desc(pct_of_all_black_residents))

seg_data$cumulative_pct_black_residents <- cumsum(seg_data$pct_of_all_black_residents)
seg_data$cumuative_pct_all_residents <- cumsum(seg_data$pct_of_all_residents)
```

```{r graph28}
seg_data
```
## Brain drain migration figures
```{r data29, eval = FALSE}
inflow <- acs_time('/data/qop/B07009/')

inflow %<>%
  transmute(
    FIPS = FIPS,
    year = year,
    
    in_no_hs = 
      `Estimate; Moved from different county within same state: - Less than high school graduate` +
      `Estimate; Moved from different state: - Less than high school graduate` + 
      `Estimate; Moved from abroad: - Less than high school graduate`,
      
    in_hs =
      `Estimate; Moved from different county within same state: - High school graduate (includes equivalency)` +
      `Estimate; Moved from different state: - High school graduate (includes equivalency)` +
      `Estimate; Moved from abroad: - High school graduate (includes equivalency)`,
    
    in_some_col_assoc = 
      `Estimate; Moved from different county within same state: - Some college or associate's degree` +
      `Estimate; Moved from different state: - Some college or associate's degree` +
      `Estimate; Moved from abroad: - Some college or associate's degree`,
    
    in_bach = 
      `Estimate; Moved from different county within same state: - Bachelor's degree` +
      `Estimate; Moved from different state: - Bachelor's degree` +
      `Estimate; Moved from abroad: - Bachelor's degree`,
    
    in_grad = 
      `Estimate; Moved from different county within same state: - Graduate or professional degree` +
      `Estimate; Moved from different state: - Graduate or professional degree` +
      `Estimate; Moved from abroad: - Graduate or professional degree`,
      
    in_bach_plus = in_bach + in_grad) %>%
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year) %>%
  summarise_all(sum) %>%
  ungroup()


outflow <- acs_time('/data/qop/B07409/', starting_year = 2007)

outflow %<>%
  transmute(
    FIPS = FIPS,
    year = year,
    
    out_no_hs = 
      `Estimate; Moved to different county within same state: - Less than high school graduate` +
      `Estimate; Moved to different state: - Less than high school graduate`,
    
    out_hs = 
      `Estimate; Moved to different county within same state: - High school graduate (includes equivalency)` +
      `Estimate; Moved to different state: - High school graduate (includes equivalency)`,
    
    out_some_col_assoc = 
      `Estimate; Moved to different county within same state: - Some college or associate's degree` +
      `Estimate; Moved to different state: - Some college or associate's degree`,
    
    out_bach = 
      `Estimate; Moved to different county within same state: - Bachelor's degree` +
      `Estimate; Moved to different state: - Bachelor's degree`,
    
    out_grad = 
      `Estimate; Moved to different county within same state: - Graduate or professional degree` +
      `Estimate; Moved to different state: - Graduate or professional degree`,
    
    out_bach_plus = out_bach + out_grad) %>%
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year) %>%
  summarise_all(sum) %>%
  ungroup()

migration <- full_join(inflow, outflow)

migration %<>%
  mutate(
    net_no_hs = in_no_hs - out_no_hs,
    net_hs = in_hs - out_hs,
    net_some_col_assoc = in_some_col_assoc - out_some_col_assoc,
    net_bach = in_bach - out_bach,
    net_grad = in_grad - out_grad,
    net_bach_plus = in_bach_plus - out_bach_plus)

migration %<>% pull_peers_FIPS()
```

```{r graph29}
graph_trendline(migration,
                'net_bach',
                rollmean = 3)

graph_trendline(migration,
                'in_bach')

graph_trendline(migration,
                'out_bach_plus')

migration$out_bach_plus = migration$out_bach_plus * -1

graph_trendline_race_peer(migration, 
                          vars = c('net_bach_plus', 'in_bach_plus', 'out_bach_plus'),
                          plot_title = 'Bachelor Degree Migration',
                          xmin = 2007)                     

```
## Disconnected youth figures
```{r data30, eval = FALSE}
acs <- read_feather('data/qop/disconnected.feather')

#Add STATEFIP, remove MSA

acs$FIPS <- NA

#PUMAs from 2005-2011
acs$FIPS[acs$STATEFIP == 1 & (acs$YEAR < 2012 & acs$PUMA %in% c(901, 905, 902, 903, 904))] <- 1073
acs$FIPS[acs$STATEFIP == 12 & (acs$YEAR < 2012 & acs$PUMA %in% c(1106, 1105, 1103, 1104, 1102, 1107))] <- 12031
acs$FIPS[acs$STATEFIP == 18 & (acs$YEAR < 2012 & acs$PUMA %in% c(2303, 2302, 2301, 2307, 2306, 2304, 2305))] <- 18097
acs$FIPS[acs$STATEFIP == 21 & (acs$YEAR < 2012 & acs$PUMA %in% c(1702, 1704, 1705, 1701, 1703))] <- 21111
acs$FIPS[acs$STATEFIP == 26 & (acs$YEAR < 2012 & acs$PUMA %in% c(1402, 1403, 1401, 1300))] <- 26081
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR < 2012 & acs$PUMA %in% c(1004, 1002, 1100, 1003, 902, 901))] <- 29095
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR < 2012 & acs$PUMA %in% c(1704, 1706, 1703, 1705, 1708, 1701, 1702, 1707))] <- 29189
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR < 2012 & acs$PUMA %in% c(1802, 1801, 1803))] <- 29510
acs$FIPS[acs$STATEFIP == 31 & (acs$YEAR < 2012 & acs$PUMA %in% c(903, 904, 902, 901))] <- 31055
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR < 2012 & acs$PUMA %in% c(1601, 1602, 1700))] <- 37081
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR < 2012 & acs$PUMA %in% c(901, 904, 902, 903, 905, 1000))] <- 37119
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR < 2012 & acs$PUMA %in% c(2701, 2703, 2702, 2602, 2601))] <- 37183
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR < 2012 & acs$PUMA %in% c(3107, 3101, 3103, 3109, 3106, 3108, 3102, 3104, 3105))] <- 39049
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR < 2012 & acs$PUMA %in% c(4503, 4502, 4401, 4404, 4501, 4403, 4402))] <- 39061
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR < 2012 & acs$PUMA %in% c(4102, 4101, 4103, 4000))] <- 39113
acs$FIPS[acs$STATEFIP == 40 & (acs$YEAR < 2012 & acs$PUMA %in% c(1400, 1302, 1301))] <- 40109
acs$FIPS[acs$STATEFIP == 40 & (acs$YEAR < 2012 & acs$PUMA %in% c(1200, 1100))] <- 40143
acs$FIPS[acs$STATEFIP == 45 & (acs$YEAR < 2012 & acs$PUMA %in% c(202, 201))] <- 45045
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR < 2012 & acs$PUMA %in% c(2202, 2205, 2204, 2201, 2203))] <- 47037
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR < 2012 & acs$PUMA %in% c(1400, 1301))] <- 47093
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR < 2012 & acs$PUMA %in% c(3202, 3105, 3104, 3103, 3102, 3201, 3101))] <- 47157
acs$FIPS[acs$STATEFIP == 51 & (acs$YEAR < 2012 & acs$PUMA %in% c(1200))] <- 51760

#PUMAs from 2012 and after
acs$FIPS[acs$STATEFIP == 1 & (acs$YEAR > 2011 & acs$PUMA %in% c(1301, 1302, 1303, 1304, 1305))] <- 1073
acs$FIPS[acs$STATEFIP == 12 & (acs$YEAR > 2011 & acs$PUMA %in% c(3101, 3102, 3103, 3104, 3105, 3106, 3107))] <- 12031
acs$FIPS[acs$STATEFIP == 18 & (acs$YEAR > 2011 & acs$PUMA %in% c(2301, 2302, 2303, 2304, 2305, 2306, 2307))] <- 18097
acs$FIPS[acs$STATEFIP == 21 & (acs$YEAR > 2011 & acs$PUMA %in% c(1701, 1702, 1703, 1704, 1705, 1706))] <- 21111
acs$FIPS[acs$STATEFIP == 26 & (acs$YEAR > 2011 & acs$PUMA %in% c(1001, 1002, 1003, 1004))] <- 26081
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR > 2011 & acs$PUMA %in% c(1001, 1002, 1003, 1004, 1005))] <- 29095
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR > 2011 & acs$PUMA %in% c(1801, 1802, 1803, 1804, 1805, 1806, 1807, 1808))] <- 29189
acs$FIPS[acs$STATEFIP == 29 & (acs$YEAR > 2011 & acs$PUMA %in% c(1901, 1902))] <- 29510
acs$FIPS[acs$STATEFIP == 31 & (acs$YEAR > 2011 & acs$PUMA %in% c(901, 902, 903, 904))] <- 31055
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR > 2011 & acs$PUMA %in% c(1701, 1702, 1703, 1704))] <- 37081
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR > 2011 & acs$PUMA %in% c(3101, 3102, 3103, 3104, 3105, 3106, 3107, 3108))] <- 37119
acs$FIPS[acs$STATEFIP == 37 & (acs$YEAR > 2011 & acs$PUMA %in% c(1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208))] <- 37183
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR > 2011 & acs$PUMA %in% c(4101, 4102, 4103, 4104, 4105, 4106, 4107, 4108, 4109, 4110, 4111))] <- 39049
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR > 2011 & acs$PUMA %in% c(5501, 5502, 5503, 5504, 5505, 5506, 5507))] <- 39061
acs$FIPS[acs$STATEFIP == 39 & (acs$YEAR > 2011 & acs$PUMA %in% c(4601, 4602, 4603, 4604))] <- 39113
acs$FIPS[acs$STATEFIP == 40 & (acs$YEAR > 2011 & acs$PUMA %in% c(1001, 1002, 1003, 1004, 1005, 1006))] <- 40109
acs$FIPS[acs$STATEFIP == 40 & (acs$YEAR > 2011 & acs$PUMA %in% c(1201, 1202, 1203))] <- 40143
acs$FIPS[acs$STATEFIP == 45 & (acs$YEAR > 2011 & acs$PUMA %in% c(102, 103, 104, 105))] <- 45045
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR > 2011 & acs$PUMA %in% c(2501, 2502, 2503, 2504, 2505))] <- 47037
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR > 2011 & acs$PUMA %in% c(1602, 1603, 1604))] <- 47093
acs$FIPS[acs$STATEFIP == 47 & (acs$YEAR > 2011 & acs$PUMA %in% c(3201, 3202, 3203, 3204, 3205, 3206, 3207, 3208))] <- 47157
acs$FIPS[acs$STATEFIP == 51 & (acs$YEAR > 2011 & acs$PUMA %in% c(51235))] <- 51760

acs <- pull_peers_FIPS(acs)
acs <- acs %>% filter(GQ == 1 | GQ == 2)

acs$FIPS[acs$FIPS == 29189] = 'MERGED'
acs$FIPS[acs$FIPS == 29510] = 'MERGED'

disconnected %<>%
  pull_peers_MSA() %>%
  add_FIPS_to_MSA() %>%
  filter(GQ == 1 | GQ == 2) %>%
  filter(AGE < 25 & AGE > 15) %>%
  mutate(
    in_school = if_else(SCHOOL == 2, 1, 0),
    in_school = replace(in_school, SCHOOL == 0 | SCHOOL == 9, NA),
    working = if_else(EMPSTAT == 1, 1, 0),
    working = replace(working, EMPSTAT == 0, NA),
    disconnected_youth = if_else(in_school == 0 & working == 0, 1, 0),
    race = if_else(RACE == 1 & HISPAN == 0, 1, 0))

disconnected_svy <- svydesign(ids = ~1, weights = ~PERWT, data = disconnected)

discon_youth <- svyby(~disconnected_youth, ~FIPS+YEAR, design = disconnected_svy, svymean, na.rm = TRUE) %>% 
  rename(year = YEAR) %>%
  select(-se)

rm(disconnected, disconnected_svy)
```

![](disconnected_youth_trendline.png)
```{r graph30}

```

