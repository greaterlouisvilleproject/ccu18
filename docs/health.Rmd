---
title: "Health"
---
<div style="margin-top:50px;">
</div>
```{r "setup", include = FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/Harrison Kirby/Desktop/GLP/ccu18")
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.showtext=TRUE)
```

```{r libraries}
#Data
library(survey)
library(tidyverse)
library(magrittr)
library(feather)
library(labelled)

#Graphing
library(ggthemes)
library(classInt)
library(showtext)
library(reshape2)
library(rbokeh)
library(wesanderson)
library(kableExtra)
library(scales)

#Mapping
library(rgdal)
library(RColorBrewer)
library(leaflet)

#Make the dplyr select function the default over the plotly select function
select <- function(...){dplyr::select(...)}
```

```{r functions}
source('helper_functions.R')
```

```{r graphing}
source('graphing_functions.R')

font_add("Museo Sans 300", "MuseoSans_300.otf")
font_add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")

#Tract Map
map_jc = readOGR('data/maps/tract', layer = "JC Tracts",
                 GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_jc$TRACT <- as.numeric(map_jc$TRACT)

nh_names <- read_csv('data/maps/tract_to_nh.csv')

nh_names$Id2 <- substr(nh_names$Id2, 6, 13)
nh_names$Id2 <- as.numeric(nh_names$Id2)

map_jc@data <- full_join(map_jc@data, nh_names, by = c('TRACT' = 'Id2'))

map_jc@data$l_line1 <- paste("Tract #:", map_jc@data$TRACT, "in the")
map_jc@data$l_line2 <- paste(map_jc@data$Neighborhood, "neighborhood")

rm(nh_names)

#Zip Code map
map_jc_zip = readOGR('data/maps/zip', layer = 'Jefferson_County_KY_ZIP_Codes',
                     GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_jc_zip$ZIPCODE <- as.numeric(map_jc_zip$ZIPCODE)

map_jc_zip@data$l_line1 <- paste0("Zip Code ", map_jc_zip@data$ZIPCODE)
```

```{r Website / output toggle}
web = TRUE
```

# Health Outcomes Index

## Ranking
```{r data16.1, eval = FALSE}
setwd("data/health/natality")

natality <- wonder_time("2003-2006", "FIPS")
natality <- rbind(natality, wonder_time("2007-2016", "FIPS"))

natality <- natality %>%
  select(year = Year, weight = `Birth Weight 12 Code`, births = Births, FIPS) %>%
  mutate(weight = as.numeric(weight), births = as.numeric(births), FIPS = as.numeric(FIPS))

natality$underweight <- if_else(natality$weight <= 5, 1, 0)

natality <- natality %>%
  group_by(FIPS, year, underweight) %>%
  summarise(babies = sum(births, na.rm = TRUE)) %>%
  ungroup() %>%
    mutate(pct_underweight = babies / sum(babies),
         FIPS = as.character(FIPS)) %>%
  filter(underweight == 1) %>%
  select(-underweight, -babies)

natality$FIPS[natality$FIPS == 29189] <- "MERGED"

natality <-  natality %>%  pull_peers_FIPS()

#Race
natality_race_03_05 <- read_tsv('Natality, 2003-2006.txt')
natality_race_07_16 <- read_tsv('Natality, 2007-2016.txt')

natality_race <- rbind(natality_race_03_05, natality_race_07_16)

natality_race <- natality_race %>%
  filter(!is.na(Year)) %>%
  rename(FIPS = `County Code`) %>%
  select(year = Year, 
         race = `Bridged Race`,
         weight = `Birth Weight 12 Code`, 
         births = Births, FIPS) %>%
  mutate(weight = as.numeric(weight), 
         births = as.numeric(births), 
         FIPS = as.numeric(FIPS),
         race = replace(race, race == "Black or African American", "black"),
         race = replace(race, race == "White", "white"),
         race = replace(race, race == "Asian or Pacific Islander", "API"),
         race = replace(race, race == "American Indian or Alaska Native", "AIAN"))

natality_race$underweight <- if_else(natality_race$weight <= 5, 1, 0)

natality_race <- natality_race %>%
  group_by(FIPS, year, underweight, race) %>%
  summarise(babies = sum(births, na.rm = TRUE)) %>%
  ungroup() %>%
  
  #weight STL
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, underweight, race) %>%
  summarise(
    babies = sum(babies, na.rm = TRUE)) %>%
  ungroup() %>%
  
  mutate(pct_underweight = babies / sum(babies),
         FIPS = as.character(FIPS)) %>%
  filter(underweight == 1) %>%
  select(-underweight, -babies) %>%
  filter(race == "white" | race == "black") %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race) %>%
        rename(pct_underweight_white = pct_underweight),
      x %>% 
        filter(race == "black") %>%
        select(-race) %>%
        rename(pct_underweight_black = pct_underweight),
      by = c("FIPS", "year"))
  }

natality %<>% bind_df(natality_race)

rm(natality_race_03_05, natality_race_07_16, natality_race)
```

```{r data16.2, eval = FALSE}
mortality_one <- read_tsv("data/health/mortality/one.txt")

mortality_suppressed <- wonder_time_single("data/health/mortality/single-year")

#one-year mortality data
mortality_one %<>%
  filter(!is.na(Year)) %>%
  select(
    FIPS = `County Code`,
    year = Year,
    age = `Single-Year Ages Code`,
    deaths = Deaths,
    population = Population) %>%
  mutate(
    age = as.numeric(age), 
    deaths = as.numeric(deaths), 
    population = as.numeric(population)) %>%
  filter(age < 75)

#Calculate supressed death numbers
mortality_50 <- mortality_one %>%
  filter(age == 50) %>%
  rename(deaths50 = deaths) %>%
  select(FIPS, year, deaths50)

mortality_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    deaths = Deaths,
    age) %>%
  left_join(mortality_50, by = c("FIPS", "year")) %>%
  mutate(deaths_suppressed = deaths - deaths50) %>%
  select(FIPS, year, age, deaths_suppressed)

#add to mortality data frame
mortality_one %<>% left_join(mortality_suppressed, by = c("FIPS", "year", "age"))

mortality_one %<>%
 {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths)),
     x %>%
       filter(is.na(deaths)) %>%
       mutate(deaths = deaths_suppressed))
 }

#Adjust to US 2000 standard population
std_pop <- read_table('C:/Users/Harrison Kirby/Desktop/GLP/ccu18/data/health/stdpop.singleagesthru84.txt',
                      col_names = FALSE)

std_pop %<>%
  transmute(geography = str_sub(X1, 1, 3),
            age = str_sub(X1, 4, 6),
            pop = str_sub(X1, 7)) %>%
  mutate_all(as.numeric) %>%
  filter(geography == 202 & age < 75) %>%
  mutate(age_pct_std = pop / sum(pop)) %>%
  select(age, age_pct_std)

mortality <- mortality_one %>%
  left_join(std_pop) %>%
  group_by(FIPS, year) %>%
  mutate(age_pct = population / sum(population)) %>%
  mutate(population = population * age_pct_std / age_pct,
         deaths = deaths * age_pct_std / age_pct) %>% 
  ungroup()

#YPLL Calculation

mortality <- mortality %>%
  mutate(years_lost = 75 - age, 
         year_loss = years_lost * deaths)

mortality <- mortality %>%
  group_by(year, FIPS) %>%
  mutate(total_population = sum(population, na.rm = TRUE)) %>%
  filter(age < 75) %>%
  mutate(total_ypll = sum(year_loss, na.rm = TRUE),
         ypll = total_ypll / (total_population / 100000)) %>%
  ungroup() %>%
  filter(age == 0) %>%
  select(FIPS, year, ypll)

rm(mortality_50, mortality_suppressed)
```

```{r mortrace, eval = FALSE}
mortality_one_race <- read_tsv("data/health/mortality/one_race.txt")

mortality_one_race %<>%
  filter(!is.na(Year)) %>%
  transmute(
    FIPS = `County Code`,
    year = Year,
    age = `Single-Year Ages Code`,
    race = Race,
    race = replace(race, race == "Black or African American", "black"),
    race = replace(race, race == "White", "white"),
    population = as.numeric(Population),
    deaths = as.numeric(Deaths))
  
mortality_race <- mortality_one %>%
  select(FIPS, year, age) %>%
  {
    x <- .
    bind_rows(
      x %>% mutate(race = "black"),
      x %>% mutate(race = "white"))
  } %>%
  left_join(mortality_one_race, by = c("FIPS", "year", "age", "race")) %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>% 
        select(-race) %>%
        rename(pop_white = population, deaths_white = deaths),
      x %>% 
        filter(race == "black") %>% 
        select(-race) %>%
        rename(pop_black = population, deaths_black = deaths),
      by = c("FIPS", "year", "age"))
  }

mortality_one_totals <- read_tsv("data/health/mortality/total_race.txt")

mortality_one_totals %<>%
  filter(!is.na(Year)) %>%
  transmute(
    FIPS = `County Code`,
    year = Year,
    age = as.numeric(`Single-Year Ages Code`),
    population_tot = as.numeric(Population),
    deaths_tot = as.numeric(Deaths))

mortality_race %<>% 
  left_join(mortality_one_totals, by = c("FIPS", "year", "age")) 

mortality_race$pop_white[mortality_race$FIPS == "51760" & 
                         mortality_race$year == 2013 &
                         mortality_race$age == 74] <-
  mortality_race$pop_white[mortality_race$FIPS == "51760" & 
                         mortality_race$year == 2012 &
                         mortality_race$age == 74]

mortality_race$deaths_white[mortality_race$FIPS == "51760" & 
                         mortality_race$year == 2013 &
                         mortality_race$age == 74] <-
  mortality_race$deaths_white[mortality_race$FIPS == "51760" & 
                         mortality_race$year == 2012 &
                         mortality_race$age == 74]
```

```{r mort_t, eval = FALSE}
mortality_tot_suppressed <- wonder_time_single("data/health/mortality/single-year whiteblack")

mortality_74 <- mortality_race %>%
  filter(age == 74) %>%
  rename(deaths74 = deaths_tot,
         pop74 = population_tot) %>%
  select(FIPS, year, deaths74, pop74)

mortality_tot_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    age,
    deaths = Deaths,
    pop = Population) %>%
  left_join(mortality_74, by = c("FIPS", "year")) %>%
  mutate(
    deaths = as.numeric(deaths),
    deaths_tot_suppressed = deaths - deaths74,
    pop_tot_suppressed = pop - pop74) %>%
  select(FIPS, year, age, deaths_tot_suppressed, pop_tot_suppressed)

#add to mortality data frame
mortality_race %<>% left_join(mortality_tot_suppressed, by = c("FIPS", "year", "age"))

mortality_race %<>%
 {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths_tot)),
     x %>%
       filter(is.na(deaths_tot)) %>%
       mutate(deaths_tot = deaths_tot_suppressed,
              population_total = pop_tot_suppressed))
 }

```

```{r mort_wh, eval = FALSE}
mortality_white_suppressed <- wonder_time_single("data/health/mortality/single-year white")

mortality_74 <- mortality_race %>%
  filter(age == 74) %>%
  rename(deaths74 = deaths_white,
         pop74 = pop_white) %>%
  select(FIPS, year, deaths74, pop74)

mortality_white_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    age,
    deaths = Deaths,
    pop = Population) %>%
  mutate(age = age - 1) %>%
  left_join(mortality_74, by = c("FIPS", "year")) %>%
  mutate(
    deaths = as.numeric(deaths),
    deaths_white_suppressed = deaths - deaths74,
    pop_white_suppressed = pop - pop74) %>%
  select(FIPS, year, age, deaths_white_suppressed, pop_white_suppressed)

#add to mortality data frame
mortality_race %<>% left_join(mortality_white_suppressed, by = c("FIPS", "year", "age"))

mortality_race %<>%
 {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths_white)),
     x %>%
       filter(is.na(deaths_white)) %>%
       mutate(deaths_white = deaths_white_suppressed,
              pop_white = pop_white_suppressed))
 } %>%
  mutate(pop_black = population_tot - pop_white,
         deaths_black = deaths_tot - deaths_white)
```

```{r mortanalysis, eval = FALSE}
mortality_race %<>%
  transmute(
    FIPS, year, age,
    population_white = pop_white,
    population_black = pop_black,
    deaths_white, deaths_black)

#YPLL Calculation

mortality_race <- mortality_race %>%
  mutate(years_lost = 75 - age, 
         year_loss_white = years_lost * deaths_white,
         year_loss_black = years_lost * deaths_black)

mortality_race <- mortality_race %>%
  group_by(year, FIPS) %>%
  mutate(
    total_population_white = sum(population_white, na.rm = TRUE),
    total_population_black = sum(population_black, na.rm = TRUE)) %>%
  filter(age < 75) %>%
  mutate(
    total_ypll_white = sum(year_loss_white, na.rm = TRUE),
    total_ypll_black = sum(year_loss_black, na.rm = TRUE),
    ypll_white = total_ypll_white / (total_population_white / 100000),
    ypll_black = total_ypll_black / (total_population_black / 100000)) %>%
  ungroup() %>%
  filter(age == 0) %>%
  select(FIPS, year, ypll_white, ypll_black)

#rm(mortality_50, mortality_suppressed)
```

```{r data16.3, eval = FALSE}
brfss <- read_feather("data/health/brfss.feather")

brfss <- brfss %>% rename(MSA = msa) %>% pull_peers_MSA()

#recode data
brfss$age[brfss$year >= 2003] <- plyr::mapvalues(brfss$age[brfss$year >= 2011], 1:6, c(1, 1, 1, 2, 2, 3))

brfss$poor_or_fair <- if_else(brfss$hlth == 4 | brfss$hlth == 5, 1, 0)
brfss$poor_or_fair[brfss$hlth == 7 | brfss$hlth == 9] <- NA

brfss$physdays[brfss$physdays == 77 | brfss$physdays == 99] <- NA
brfss$physdays[brfss$physdays == 88] <- 0

brfss$mentdays[brfss$mentdays == 77 | brfss$mentdays == 99] <- NA
brfss$mentdays[brfss$mentdays == 88] <- 0

brfss <- brfss %>% filter(year > 2003)

#create survey objects
brfss_svy <- svydesign(ids = ~0, weights = ~wgt, data = brfss)
pop_age <- c(0.530534557, 0.299194019, 0.170271424)

#brfss_svy_std <- svystandardize(brfss_svy, by = ~age, over = ~MSA+year, population = pop_age, excluding.missing = ~poor_or_fair+physdays+mentdays)

#brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy_std, svymean, na.rm = TRUE) %>%
#  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy, svymean, na.rm = TRUE) %>%
  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results$city<-NA
brfss_results$city[brfss_results$MSA == 24340] = "Grand Rapids"
brfss_results$city[brfss_results$MSA == 41180] = "St. Louis"
brfss_results$city[brfss_results$MSA == 36420] = "Oklahoma City"
brfss_results$city[brfss_results$MSA == 46140] = "Tulsa"
brfss_results$city[brfss_results$MSA == 24860] = "Greenville"
brfss_results$city[brfss_results$MSA == 28940] = "Knoxville"
brfss_results$city[brfss_results$MSA == 13820] = "Birmingham"
brfss_results$city[brfss_results$MSA == 31140] = "Louisville"
brfss_results$city[brfss_results$MSA == 26900] = "Indianapolis"
brfss_results$city[brfss_results$MSA == 28140] = "Kansas City"
brfss_results$city[brfss_results$MSA == 36540] = "Omaha"
brfss_results$city[brfss_results$MSA == 24660] = "Greensboro"
brfss_results$city[brfss_results$MSA == 16740] = "Charlotte"
brfss_results$city[brfss_results$MSA == 18140] = "Columbus"
brfss_results$city[brfss_results$MSA == 17140] = "Cincinnati"
brfss_results$city[brfss_results$MSA == 34980] = "Nashville"
brfss_results$city[brfss_results$MSA == 32820] = "Memphis"
brfss_results$city[brfss_results$MSA == 27260] = "Jacksonville"
brfss_results$city[brfss_results$MSA == 39580] = "Raleigh"
brfss_results$city[brfss_results$MSA == 19380] = "Dayton"
brfss_results$city[brfss_results$MSA == 40060] = "Richmond"

g_2015 <- brfss_results[brfss_results$city == "Greensboro" & brfss_results$year == 2014, 1:6]
g_2015$year <- 2015

brfss_results <- rbind(brfss_results, g_2015)

g_2015$year <- 2016
brfss_results <- rbind(brfss_results, g_2015)

msa_fips <- read_csv('data/MSA to FIPS.csv') %>% select(-city) %>% mutate(FIPS = as.character(FIPS))

natality <- left_join(natality, msa_fips)
mortality <- left_join(mortality, msa_fips) %>% select(-FIPS)

#Create index
health_index <- full_join(mortality, natality, by = c("MSA", "year")) %>% select(-city)
health_index <- full_join(health_index, brfss_results, by = c("MSA", "year"))

health_index <- health_index %>%
  filter(current == 1) %>%
  select(FIPS, year, ypll, pct_underweight, poor_or_fair, physdays, mentdays) %>%
  filter(year > 2003)

# give St. Louis a new FIPS
health_index$FIPS[health_index$FIPS == 29189] <- "MERGED"

#Create index
norm_z <- function(x){
z <- (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}

health_z <- health_index
health_z <- map_df(health_z, remove_var_label)

health_z <- health_z %>%
  group_by(year) %>%
  mutate(ypll_index = norm_z(ypll),
         pct_underweight_index = norm_z(pct_underweight),
         poor_or_fair_index = norm_z(poor_or_fair),
         physdays_index = norm_z(physdays),
         mentdays_index = norm_z(mentdays)) %>%
  ungroup()

health_z <- health_z %>%
  mutate(
    health_index = 
      -1 *
      ypll_index*.5+
      pct_underweight_index*.2+
      poor_or_fair_index*.1+
      physdays_index*.1+
      mentdays_index*.1)

data <- health_z %>% pull_peers_FIPS()

"file:///C:/Users/Harrison Kirby/Desktop/GLP/ccu18/data/health/brfss_data_race.feather"

rm(brfss, brfss_results, brfss_svy, brfss_svy_std, health_index, health_z, mortality, mortality_age, mortality_one, mortality_ten, std_pop, g_2015, msa_fips)
```

```{r brfssrace, eval = FALSE}
brfss <- read_feather("data/health/brfss_race.feather")

brfss <- brfss %>% rename(MSA = msa) %>% pull_peers_MSA()

#recode data
brfss$age[brfss$year >= 2003] <- plyr::mapvalues(brfss$age[brfss$year >= 2011], 1:6, c(1, 1, 1, 2, 2, 3))

brfss$race <- replace(brfss$race, brfss$race >3, NA)
brfss$race <- replace(brfss$race, brfss$race == 1, "white")
brfss$race <- replace(brfss$race, brfss$race == 2, "black")
brfss$race <- replace(brfss$race, brfss$race == 3, "hisp")

brfss$poor_or_fair <- if_else(brfss$hlth == 4 | brfss$hlth == 5, 1, 0)
brfss$poor_or_fair[brfss$hlth == 7 | brfss$hlth == 9] <- NA

brfss$physdays[brfss$physdays == 77 | brfss$physdays == 99] <- NA
brfss$physdays[brfss$physdays == 88] <- 0

brfss$mentdays[brfss$mentdays == 77 | brfss$mentdays == 99] <- NA
brfss$mentdays[brfss$mentdays == 88] <- 0

brfss <- brfss %>% filter(year > 2003)

#create survey objects
brfss_svy <- svydesign(ids = ~0, weights = ~wgt, data = brfss)
pop_age <- c(0.530534557, 0.299194019, 0.170271424)

#brfss_svy_std <- svystandardize(brfss_svy, by = ~age, over = ~MSA+year, population = pop_age, excluding.missing = ~poor_or_fair+physdays+mentdays)

#brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy_std, svymean, na.rm = TRUE) %>%
#  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year+race, design = brfss_svy, svymean, na.rm = TRUE) %>%
  select(MSA, year, race, poor_or_fair, physdays, mentdays) %>%
  mutate(poor_or_fair = poor_or_fair * 100)

brfss_results$city<-NA
brfss_results$city[brfss_results$MSA == 24340] = "Grand Rapids"
brfss_results$city[brfss_results$MSA == 41180] = "St. Louis"
brfss_results$city[brfss_results$MSA == 36420] = "Oklahoma City"
brfss_results$city[brfss_results$MSA == 46140] = "Tulsa"
brfss_results$city[brfss_results$MSA == 24860] = "Greenville"
brfss_results$city[brfss_results$MSA == 28940] = "Knoxville"
brfss_results$city[brfss_results$MSA == 13820] = "Birmingham"
brfss_results$city[brfss_results$MSA == 31140] = "Louisville"
brfss_results$city[brfss_results$MSA == 26900] = "Indianapolis"
brfss_results$city[brfss_results$MSA == 28140] = "Kansas City"
brfss_results$city[brfss_results$MSA == 36540] = "Omaha"
brfss_results$city[brfss_results$MSA == 24660] = "Greensboro"
brfss_results$city[brfss_results$MSA == 16740] = "Charlotte"
brfss_results$city[brfss_results$MSA == 18140] = "Columbus"
brfss_results$city[brfss_results$MSA == 17140] = "Cincinnati"
brfss_results$city[brfss_results$MSA == 34980] = "Nashville"
brfss_results$city[brfss_results$MSA == 32820] = "Memphis"
brfss_results$city[brfss_results$MSA == 27260] = "Jacksonville"
brfss_results$city[brfss_results$MSA == 39580] = "Raleigh"
brfss_results$city[brfss_results$MSA == 19380] = "Dayton"
brfss_results$city[brfss_results$MSA == 40060] = "Richmond"

g_2015 <- brfss_results[brfss_results$city == "Greensboro" & brfss_results$year == 2014, 1:7]
g_2015$year <- 2015

brfss_results <- rbind(brfss_results, g_2015)

g_2015$year <- 2016
brfss_results <- rbind(brfss_results, g_2015)

brfss_results <- brfss_results %>%
  {
    x <- .
    
    first <- full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_white = poor_or_fair,
               physdays_white = physdays,
               mentdays_white = mentdays),
      x %>% 
        filter(race == "black") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_black = poor_or_fair,
               physdays_black = physdays,
               mentdays_black = mentdays),
      by = c("MSA", "year"))
    
    second <-
      full_join(
      first,
      x %>% 
        filter(race == "hisp") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_hispanic = poor_or_fair,
               physdays_hispanic = physdays,
               mentdays_hispanic = mentdays),
      by = c("MSA", "year"))
  }
```

```{r graph16race, eval = FALSE}
mortality_race %<>% pull_peers_FIPS()

graph_trendline(
  mortality_race,
  var = 'ypll_white',
  rollmean = 3,
  plot_title = "Years of potential life lost per 100,000 White Residents",
  y_title="Years",
  xmin = 2000,
  xmax = 2016,
  caption_text = "Source: Greater Louisville Project 
                  Data from the CDC")

graph_trendline(
  mortality_race,
  var = 'ypll_black',
  rollmean = 3,
  plot_title = "Years of potential life lost per 100,000 White Residents",
  y_title="Years",
  xmin = 2000,
  xmax = 2016,
  caption_text = "Source: Greater Louisville Project 
                  Data from the CDC")

graph_trendline_race_peer_two(mortality_race, 
                          vars = c('ypll_white', "ypll_black"),
                          plot_title = "YPLL",
                          xmin = 2000)

```

```{r, eval = FALSE}
add_FIPS_to_MSA <- function(data){
  
  data$FIPS<-NA
  data$FIPS[data$MSA == 24340] = 26081
  data$FIPS[data$MSA == 41180] = 'MERGE'
  data$FIPS[data$MSA == 36420] = 40109
  data$FIPS[data$MSA == 46140] = 40143
  data$FIPS[data$MSA == 24860] = 45045
  data$FIPS[data$MSA == 28940] = 47093
  data$FIPS[data$MSA == 13820] = 1073
  data$FIPS[data$MSA == 31140] = 21111
  data$FIPS[data$MSA == 26900] = 18097
  data$FIPS[data$MSA == 28140] = 29095
  data$FIPS[data$MSA == 36540] = 31055
  data$FIPS[data$MSA == 24660] = 37081
  data$FIPS[data$MSA == 16740] = 37119
  data$FIPS[data$MSA == 18140] = 39049
  data$FIPS[data$MSA == 17140] = 39061
  data$FIPS[data$MSA == 34980] = 47037
  data$FIPS[data$MSA == 32820] = 47157
  data$FIPS[data$MSA == 27260] = 12031
  data$FIPS[data$MSA == 39580] = 37183
  data$FIPS[data$MSA == 19380] = 39113
  data$FIPS[data$MSA == 40060] = 51760
  
  data
}
  

brfss_results %<>% add_FIPS_to_MSA() %>% pull_peers_FIPS()

graph_trendline_race_peer(brfss_results, 
                          vars = c('poor_or_fair_white', 'poor_or_fair_black', 'poor_or_fair_hispanic'),
                          plot_title = "Poor or Fair Health by Ethnicity",
                          rollmean = 5)

graph_trendline_race_peer(brfss_results, 
                          vars = c('physdays_white', 'physdays_black', 'physdays_hispanic'),
                          plot_title = "Physically Unhealthy Days by Ethnicity",
                          rollmean = 5,
                          y_title="Days")

graph_trendline_race_peer(brfss_results, 
                          vars = c('mentdays_white', 'mentdays_black', 'mentdays_hispanic'),
                          plot_title = "Mentally Unhealthy Days by Ethnicity",
                          rollmean = 5,
                          y_title="Days")

graph_trendline_race_peer_two(natality, 
                          vars = c('pct_underweight_white', 'pct_underweight_black'),
                          plot_title = "PCT Underweight")


```
![](outcomes_ranking.png)
## Trendline
```{r data17}

```

```{r graph17}

```
![](outcomes_trendline.png)
# Page 2

## Health Factors
```{r}
chr <- read_csv("data/health/chr_measures_CSV_2018.csv")

chr %<>%
  mutate(FIPS = paste0(`FIPS State Code`, `FIPS County Code`)) %>%
  pull_peers_FIPS() %>%
  select(
    FIPS,
    premature_death = measure_1_value,
    poor_or_fair_health = measure_2_value,
    poor_physical_health_days = measure_36_value,
    poor_mental_health_days = measure_42_value,
    low_birthweight = measure_37_value,
    adult_smoking = measure_9_value,
    adult_obesity = measure_11_value,
    food_environment_index = measure_133_value,
    physical_inactivity = measure_70_value,
    access_to_exercise_opportunities = measure_132_value,
    excessive_drinking = measure_49_value,
    alcohol_impaired_driving_deaths = measure_134_value,
    sexually_transmitted_infections = measure_45_value,
    teen_births = measure_14_value,
    uninsured = measure_85_value,
    primary_care_physicians = measure_4_value,
    dentists = measure_88_value,
    mental_health_providers = measure_62_value,
    preventable_hospital_stays = measure_5_value,
    diabetes_monitoring = measure_7_value,
    mammography_screening = measure_50_value,
    high_school_graduation = measure_21_value,
    some_college = measure_69_value,
    unemployment = measure_23_value,
    children_in_poverty = measure_24_value,
    income_inequality = measure_44_value,
    children_in_single_parent_households = measure_82_value,
    social_associations = measure_140_value,
    violent_crime = measure_43_value,
    injury_deaths = measure_135_value,
    air_pollution = measure_125_value,
    drinking_water = measure_124_value,
    severe_housing_problems = measure_136_value,
    driving_alone_to_work = measure_67_value,
    long_commute = measure_137_value) %>%
  mutate(
    year = 2016,
    FIPS = as.numeric(FIPS)) %>%
  mutate_at(
    vars(poor_or_fair_health, low_birthweight, adult_smoking, adult_obesity, physical_inactivity,
         access_to_exercise_opportunities, excessive_drinking, alcohol_impaired_driving_deaths, uninsured,
         diabetes_monitoring, mammography_screening, severe_housing_problems, driving_alone_to_work,
         long_commute),
    funs(. * 100))

chr %<>%
  weight_stl(names(chr)[names(chr) %!in% c("FIPS", "year")])

norm_z <- function(x){
  z <- (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}

chr_z <- chr 

chr_z %<>% 
  mutate_at(
    vars(names(chr_z)[names(chr_z) %!in% c("FIPS", "year")]), 
    norm_z)

chr_z %<>%
  mutate(
    outcomes = 
      premature_death * -0.5 +
      poor_or_fair_health * -0.1 +
      poor_physical_health_days * -0.1 +
      poor_mental_health_days * -0.1 +
      low_birthweight * -0.1,
    
    health_behaviors = 
      adult_smoking * -0.1 +
      adult_obesity * -0.05 +
      food_environment_index * 0.02 +
      physical_inactivity * 0.02 +
      access_to_exercise_opportunities * 0.01 +
      excessive_drinking * -0.025 +
      alcohol_impaired_driving_deaths * -0.025 +
      sexually_transmitted_infections * -0.025 +
      teen_births * -0.025,
    
    clinical_care = 
      uninsured * -0.05 +
      primary_care_physicians * 0.03 +
      dentists * 0.01 +
      mental_health_providers * 0.01 +
      preventable_hospital_stays * -0.05 +
      diabetes_monitoring * 0.025 +
      mammography_screening * 0.025,
    
    social_and_economic = 
      high_school_graduation * 0.05 +
      some_college * 0.05 +
      unemployment * -0.10 +
      children_in_poverty * -0.075 +
      income_inequality * -0.025 +
      children_in_single_parent_households * -0.025 +
      social_associations * 0.025 +
      violent_crime * -0.025 +
      injury_deaths * -0.025,
    
    physical_environment = 
      air_pollution * -0.05 +
      severe_housing_problems * -0.02 +
      driving_alone_to_work * -0.02 +
      long_commute * -0.01,
    
    factors = health_behaviors + clinical_care + social_and_economic + physical_environment) %>%
  rename_at(
    vars(names(chr_z)[names(chr_z) %!in% c("FIPS", "year", "outcomes", "health_behaviors", "clinical_care", "social_and_economic", "physical_environment", "factors")]),
    funs(paste0(., "_z")))

data <- chr_z %>% pull_peers_FIPS()
  
```

### 1. Social and Economic Factors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "social_and_economic", 
                  plot_title = "Social and Economic Health Factors, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

### 2. Health Behaviors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "health_behaviors", 
                  plot_title = "Health Behaviors, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

### 3. Clinical Care
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "clinical_care", 
                  plot_title = "Clinical Care, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

### 4. Social and Economic Factors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "physical_environment", 
                  plot_title = "Physical Environment, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

### Outcomes Index
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "outcomes", 
                  plot_title = "Outcomes, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

### Factor Index
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "factors", 
                  plot_title = "Factor Index, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

## Health Insurance
```{r data20.1}
insurance <- acs_time("/data/health/C27001/", starting_year = 2009)

insurance %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsured_rate =
      (`Estimate; Male: - Under 18 years: - No health insurance coverage` +
      `Estimate; Male: - 18 to 64 years: - No health insurance coverage` + 
      `Estimate; Male: - 65 years and over: - No health insurance coverage` +
      `Estimate; Female: - Under 18 years: - No health insurance coverage` +
      `Estimate; Female: - 18 to 64 years: - No health insurance coverage` + 
      `Estimate; Female: - 65 years and over: - No health insurance coverage`)
      / total * 100,
    
    insured_rate = 100 - uninsured_rate) %>%
  weight_stl('insured_rate', 'total')


data %<>% bind_df(insurance)

data %<>% select(FIPS, city, year, current, baseline, everything())

rm(insurance)
```
### 5. Ranking

```{r graph 20.4}
rank_and_nb_group(data[data$year == 2016,],
                  'insured_rate',
                  plot_title = 'Health Insurance, 2016')
```

### 6. Trendline
```{r graph20}
graph_trendline(data,
                'insured_rate',
                plot_title = 'Health Insurance',
                xmin = 2009)
```

### 7. By Race
```{r data20.2}
insurance_white <- acs_time("/data/health/C27001H/", starting_year = 2009)

insurance_white %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_white =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100,
    
    insured_rate_white = 100 - uninsurance_rate_white) %>%
  weight_stl('insured_rate_white', 'total') 

insurance_black <- acs_time("/data/health/C27001B/", starting_year = 2009)

insurance_black %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_black =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100,
    
    insured_rate_black = 100 - uninsurance_rate_black) %>%
  weight_stl('insured_rate_black', 'total') 

insurance_hisp <- acs_time("/data/health/C27001I/", starting_year = 2009)

insurance_hisp %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsurance_rate_hispanic =
      (`Estimate; Under 18 years: - No health insurance coverage` +
      `Estimate; 18 to 64 years: - No health insurance coverage` + 
      `Estimate; 65 years and over: - No health insurance coverage`)
      / total * 100,
    
    insured_rate_hispanic = 100 - uninsurance_rate_hispanic) %>%
  weight_stl('insured_rate_hispanic', 'total') 

data %<>% bind_df(insurance_white, insurance_black, insurance_hisp)

rm(insurance_white, insurance_black, insurance_hisp)
```

```{r graph20.2}
graph_trendline_race_peer(data, 
                          vars = c('insured_rate_white', 'insured_rate_black', 'insured_rate_hispanic'),
                          xmin = 2009,
                          plot_title = 'Health Insurance by Ethnicity')
```

### 8. By Poverty
```{r data21}
uninsured_income_09 <- acs_time('/data/health/B27016/Y09/', starting_year = 2009)

uninsured_income_09 %<>%
  mutate(
    insured_per_0.5_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; Under 0.50 of poverty threshold:`,
    
    insured_per_0.5_to_.99_pov = 
      (`Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 0.50 to .99 of poverty threshold:`,
    
    insured_per_1_to_1.49_pov = 
      (`Estimate; 1.00 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.00 to 1.49 of poverty threshold:`,
    
    insured_per_1.5_to_1.99_pov = 
      (`Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.50 to 1.99 of poverty threshold:`,
    
    insured_per_2_to_2.99_pov = 
      (`Estimate; 2.00 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.00 to 2.99 of poverty threshold:`,
    
    insured_per_3_to_3.99_pov = 
      (`Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 3.00 to 3.99 of poverty threshold:`,
    
    insured_per_4_plus_pov = 
      (`Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 4.00 of poverty threshold and over:`,
    
    insured_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /(`Estimate; Under 0.50 of poverty threshold:` +`Estimate; 0.50 to .99 of poverty threshold:`) * 100,
    
    insured_nonpov = 
      (`Estimate; 1.00 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /(`Estimate; 1.00 to 1.49 of poverty threshold:` + `Estimate; 1.50 to 1.99 of poverty threshold:` +
        `Estimate; 2.00 to 2.99 of poverty threshold:` + `Estimate; 3.00 to 3.99 of poverty threshold:` +
        `Estimate; 4.00 of poverty threshold and over:`) * 100) %>%
  weight_stl(c('insured_per_0.5_pov', 'insured_per_0.5_to_.99_pov', 'insured_per_1_to_1.49_pov',
               'insured_per_1.5_to_1.99_pov', 'insured_per_2_to_2.99_pov', 'insured_per_3_to_3.99_pov',
               'insured_per_4_plus_pov', 'insured_pov', 'insured_nonpov')) %>%
  mutate(insured_per_2_to_2.49_pov = NA,
         insured_per_2.5_to_2.99_pov = NA,
         insured_per_1_to_1.37_pov = NA,
         insured_per_1.38_1.49_pov = NA)

uninsured_income_11 <- acs_time('/data/health/B27016/Y11/', starting_year = 2011)

uninsured_income_11 %<>%
  mutate(
    insured_per_0.5_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; Under 0.50 of poverty threshold:`,
    
    insured_per_0.5_to_.99_pov = 
      (`Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 0.50 to .99 of poverty threshold:`,
    
    insured_per_1_to_1.37_pov =
      (`Estimate; 1.00 to 1.37 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.00 to 1.37 of poverty threshold:`,

    insured_per_1.38_1.49_pov =
      (`Estimate; 1.38 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.38 to 1.49 of poverty threshold:`,
    
    insured_per_1_to_1.49_pov = 
      (`Estimate; 1.00 to 1.37 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      / (`Estimate; 1.00 to 1.37 of poverty threshold:` + `Estimate; 1.38 to 1.49 of poverty threshold:`),
    
    insured_per_1.5_to_1.99_pov = 
      (`Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 1.50 to 1.99 of poverty threshold:`,
    
    insured_per_2_to_2.49_pov =
      (`Estimate; 2.00 to 2.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.00 to 2.49 of poverty threshold:`,

    insured_per_2.5_to_2.99_pov =
      (`Estimate; 2.50 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 2.50 to 2.99 of poverty threshold:`,

    insured_per_2_to_2.99_pov = 
      (`Estimate; 2.00 to 2.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      / (`Estimate; 2.00 to 2.49 of poverty threshold:` + `Estimate; 2.50 to 2.99 of poverty threshold:`),
    
    insured_per_3_to_3.99_pov =
      (`Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 3.00 to 3.99 of poverty threshold:`, 

    insured_per_4_plus_pov = 
      (`Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /`Estimate; 4.00 of poverty threshold and over:`,
    
    insured_pov = 
      (`Estimate; Under 0.50 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; Under 0.50 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 0.50 to .99 of poverty threshold: - 65 years and over: - With health insurance coverage`)
      /(`Estimate; Under 0.50 of poverty threshold:` +`Estimate; 0.50 to .99 of poverty threshold:`) * 100,
    
    insured_nonpov = 
      (`Estimate; 1.00 to 1.37 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.00 to 1.37 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.38 to 1.49 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 1.50 to 1.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.00 to 2.49 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 2.50 to 2.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - Under 18 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 3.00 to 3.99 of poverty threshold: - 65 years and over: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - Under 18 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 18 to 64 years: - With health insurance coverage` +
      `Estimate; 4.00 of poverty threshold and over: - 65 years and over: - With health insurance coverage`)
      /(`Estimate; 1.00 to 1.37 of poverty threshold:` + `Estimate; 1.38 to 1.49 of poverty threshold:` + `Estimate; 1.50 to 1.99 of poverty threshold:` +
        `Estimate; 2.00 to 2.49 of poverty threshold:` + `Estimate; 2.50 to 2.99 of poverty threshold:` +
        `Estimate; 3.00 to 3.99 of poverty threshold:` + `Estimate; 4.00 of poverty threshold and over:`) * 100) %>%
  weight_stl(c('insured_per_0.5_pov', 'insured_per_0.5_to_.99_pov', 'insured_per_1_to_1.37_pov',
               'insured_per_1.38_1.49_pov', 'insured_per_1_to_1.49_pov', 'insured_per_1.5_to_1.99_pov',
               'insured_per_2_to_2.49_pov','insured_per_2.5_to_2.99_pov', 'insured_per_2_to_2.99_pov',
               'insured_per_3_to_3.99_pov', 'insured_per_4_plus_pov', 'insured_pov', 'insured_nonpov'))

uninsured_income <- bind_rows(uninsured_income_09, uninsured_income_11)

data %<>% bind_df(uninsured_income)

rm(uninsured_income_09, uninsured_income_11, uninsured_income)

```

```{r graph 21.1}
graph_trendline_race_peer_two(data, 
                          vars = c('insured_pov', 'insured_nonpov'),
                          cat_labels = c("Poverty","Nonpoverty"),
                          plot_title = "Health Insurance by Poverty Status",
                          xmin = 2011)
```

```{r graph21, eval = FALSE}
uninsured_graph <- data %>% 
  gather(insured_per_0.5_pov:insured_per_1.38_1.49_pov, key = 'key', value = 'value') %>%
  filter(FIPS == 21111) #change to data

ggplotly(ggplot(uninsured_graph, aes(x = year, y = value, color = key)) + 
  geom_line())

rm(uninsured_graph)
```

## Overdoses
### Opioid Deaths
```{r opioid}
opioid <- read_tsv('data/health/opioid/Underlying Cause of Death, 1999-2016.txt')

opioid %<>%
  filter(!is.na(Year)) %>%
  mutate(
    FIPS = as.numeric(`County Code`),
    year = Year,
    deaths = as.numeric(Deaths),
    population = as.numeric(Population),
    overdose = `Age Adjusted Rate`,
    overdose = replace(overdose, overdose == "Unreliable", deaths / population * 1000),
    overdose = as.numeric(overdose)) %>%
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, `Drug/Alcohol Induced Code`) %>%
  summarise(
    overdose = weighted.mean(overdose, population),
    deaths = sum(deaths),
    population = sum(population)) %>%
  ungroup() %>%
  group_by(year, FIPS) %>%
  mutate(total_deaths = sum(deaths)) %>%
  ungroup() %>%
  filter(`Drug/Alcohol Induced Code` == "D") %>%
  mutate(
    overdose_per = deaths / total_deaths * 100) %>%
  select(
    year, FIPS,
    overdose,
    overdose_per)

opioid_race <- read_tsv('data/health/opioid/Underlying Cause of Death, 1999-2016 race.txt')

opioid_race %<>%
  #delete notes rows
  filter(!is.na(Year)) %>%
  
  #mutate variables
  transmute(
    FIPS = as.numeric(`County Code`),
    year = Year,
    `Drug/Alcohol Induced Code`,
    race = replace(Race, Race == "American Indian or Alaska Native", "AIAN"),
    race = replace(race, Race == "Asian or Pacific Islander", "API"),
    race = replace(race, Race == "Black or African American", "black"),
    race = replace(race, Race == "White", "white"),
    deaths = as.numeric(Deaths),
    population = as.numeric(Population),
    overdose = `Age Adjusted Rate`,
    overdose = replace(overdose, overdose == "Unreliable", deaths / population * 1000),
    overdose = as.numeric(overdose)) %>%
  
  #weight STL
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, `Drug/Alcohol Induced Code`, race) %>%
  summarise(
    overdose = weighted.mean(overdose, population),
    deaths = sum(deaths),
    population = sum(population)) %>%
  ungroup() %>%
  
  #calculate percent of deaths
  group_by(year, FIPS, race) %>%
  mutate(total_deaths = sum(deaths)) %>%
  ungroup() %>%
  
  #filter to overdoses
  filter(`Drug/Alcohol Induced Code` == "D") %>%
  mutate(
    overdose_per = deaths / total_deaths * 100) %>%
  select(
    year, FIPS, race,
    overdose,
    overdose_per) %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race) %>%
        rename(overdose_white = overdose, overdose_white_per = overdose_per),
      x %>% 
        filter(race == "black") %>%
        select(-race) %>%
        rename(overdose_black = overdose, overdose_black_per = overdose_per),
      by = c("FIPS", "year"))
  }

opioid %<>% pull_peers_FIPS()
opioid %<>% bind_df(opioid_race)
```

### 9. Ranking {.tabset}

#### Mortality rate
```{r}
rank_and_nb_group(opioid[opioid$year == 2016,],
                  'overdose',
                  plot_title = 'Overdoses, 2016',
                  y_title = "Overdose Deaths per 100,000 residents",
                  order = "Ascending")
```

#### Percent of deaths
```{r}
rank_and_nb_group(opioid[opioid$year == 2016,],
                  'overdose_per',
                  plot_title = 'Percent of Deaths that are Overdoses, 2016',
                  y_title = "Percent",
                  order = "Ascending")
```

### 10. Trendline

#### Mortality rate
```{r}
graph_trendline(opioid,
                'overdose',
                plot_title = 'Overdoses',
                xmin = 2000,
                y_title = "Overdose Deaths per 100,000 residents")
```

#### Percent of deaths
```{r}
graph_trendline(opioid,
                'overdose_per',
                plot_title = 'Percent of Deaths that are Overdoses',
                xmin = 2000,
                y_title = "Percent")
```

### 11. Overdoses by Race

#### Mortality rate
```{r}
graph_trendline_race_peer_two(opioid, 
                          vars = c('overdose_white', 'overdose_black'),
                          plot_title = "Overdoses by race",
                          xmin = 2000,
                          y_title = "Overdoses Deaths per 100,000",
                          rollmean = 3)
```

#### Percent of deaths
```{r}
graph_trendline_race_peer_two(opioid, 
                          vars = c('overdose_white_per', 'overdose_black_per'),
                          plot_title = "Overdoses by race",
                          xmin = 2000,
                          y_title = "Overdoses Deaths per 100,000",
                          rollmean = 3)
```


