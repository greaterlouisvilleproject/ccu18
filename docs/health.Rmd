---
title: "Health"
---
<div style="margin-top:50px;">
</div>
```{r "setup", include = FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/Harrison Kirby/Desktop/GLP/ccu18")
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.showtext=TRUE)
```

```{r libraries}
#Data
library(survey)
library(tidyverse)
library(magrittr)
library(feather)
library(labelled)

#Graphing
library(ggthemes)
library(classInt)
library(showtext)
library(reshape2)
library(rbokeh)
library(wesanderson)
library(kableExtra)
library(scales)

#Mapping
library(rgdal)
library(RColorBrewer)
library(leaflet)

#Make the dplyr select function the default over the plotly select function
select <- function(...){dplyr::select(...)}
```

```{r functions}
source('helper_functions.R')
```

```{r graphinghealth}
source('graphing_functions.R')

font_add("Museo Sans 300", "MuseoSans_300.otf")
font_add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")

#Tract Map
map_tract = readOGR('data/maps/tract', layer = "tract",
                 GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_tract$TRACT <- as.numeric(map_tract$TRACT)

nh_names <- read_csv('data/maps/tract_to_nh.csv')

nh_names$Id2 <- substr(nh_names$Id2, 6, 13)
nh_names$Id2 <- as.numeric(nh_names$Id2)

map_tract@data <- full_join(map_tract@data, nh_names, by = c('TRACT' = 'Id2'))

map_tract@data$l_line1 <- paste("Tract #:", map_tract@data$TRACT, "in the")
map_tract@data$l_line2 <- paste(map_tract@data$Neighborhood, "neighborhood")

rm(nh_names)

#Zip Code map
map_jc_zip = readOGR('data/maps/zip', layer = 'Jefferson_County_KY_ZIP_Codes',
                     GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_jc_zip$ZIPCODE <- as.numeric(map_jc_zip$ZIPCODE)

map_jc_zip@data$l_line1 <- paste0("Zip Code ", map_jc_zip@data$ZIPCODE)

#Market Area

map_market = readOGR('data/maps/market area', layer = "market area",
                 GDAL1_integer64_policy = TRUE, stringsAsFactors = FALSE, verbose = FALSE)

map_market@data %<>% rename(market = Area)

map_market@data$l_line1 <- map_market@data$market

#map_market@data$l_line1 <- map_jc_@data$ZIPCODE
```

```{r Website / output toggle}
web = TRUE
```

# MM: Health Outcomes Index

## 1. Ranking
```{r natality}
setwd("data/health/natality")

natality <- wonder_time("2003-2006", "FIPS")
natality <- rbind(natality, wonder_time("2007-2016", "FIPS"))

natality <- natality %>%
  select(year = Year, weight = `Birth Weight 12 Code`, births = Births, FIPS) %>%
  mutate(weight = as.numeric(weight), births = as.numeric(births), FIPS = as.numeric(FIPS))

natality$underweight <- if_else(natality$weight <= 5, 1, 0)

natality <- natality %>%
  group_by(FIPS, year, underweight) %>%
  summarise(babies = sum(births, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(FIPS, year) %>%
  mutate(pct_underweight = babies / sum(babies) * 100) %>%
  ungroup() %>%
  filter(underweight == 1) %>%
  select(-underweight, -babies)

natality$FIPS[natality$FIPS == 29189] <- "MERGED"
```

```{r natalityrace}
setwd("data/health/natality")

#Race
natality_race_03_05 <- read_tsv('Natality, 2003-2006.txt')
natality_race_07_16 <- read_tsv('Natality, 2007-2016.txt')

natality_race <- rbind(natality_race_03_05, natality_race_07_16)

natality_race <- natality_race %>%
  filter(!is.na(Year)) %>%
  rename(FIPS = `County Code`) %>%
  select(year = Year, 
         race = `Bridged Race`,
         weight = `Birth Weight 12 Code`, 
         births = Births, FIPS) %>%
  mutate(weight = as.numeric(weight), 
         births = as.numeric(births), 
         FIPS = as.numeric(FIPS),
         race = replace(race, race == "Black or African American", "black"),
         race = replace(race, race == "White", "white"),
         race = replace(race, race == "Asian or Pacific Islander", "API"),
         race = replace(race, race == "American Indian or Alaska Native", "AIAN"))

natality_race$underweight <- if_else(natality_race$weight <= 5, 1, 0)

natality_race <- natality_race %>%
  group_by(FIPS, year, underweight, race) %>%
  summarise(babies = sum(births, na.rm = TRUE)) %>%
  ungroup() %>%
  
  #weight STL
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, underweight, race) %>%
  summarise(
    babies = sum(babies, na.rm = TRUE)) %>%
  ungroup() %>%
  
  group_by(FIPS, year) %>%
  mutate(pct_underweight = babies / sum(babies) * 100) %>%
  ungroup() %>%
  
  filter(underweight == 1) %>%
  select(-underweight, -babies) %>%
  filter(race == "white" | race == "black") %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race) %>%
        rename(pct_underweight_white = pct_underweight),
      x %>% 
        filter(race == "black") %>%
        select(-race) %>%
        rename(pct_underweight_black = pct_underweight),
      by = c("FIPS", "year"))
  }

natality %<>% 
  bind_df(natality_race) %>% 
  select(FIPS, year, everything())

rm(natality_race_03_05, natality_race_07_16, natality_race)
```

```{r mortality}
mortality_one <- read_tsv("data/health/mortality/one.txt")

mortality_suppressed <- wonder_time_single("data/health/mortality/single-year")

#one-year mortality data
mortality_one %<>%
  filter(!is.na(Year)) %>%
  select(
    FIPS = `County Code`,
    year = Year,
    age = `Single-Year Ages Code`,
    deaths = Deaths,
    population = Population) %>%
  mutate(
    age = as.numeric(age), 
    deaths = as.numeric(deaths), 
    population = as.numeric(population)) %>%
  filter(age < 75)

#Calculate supressed death numbers
mortality_50 <- mortality_one %>%
  filter(age == 50) %>%
  rename(deaths50 = deaths) %>%
  select(FIPS, year, deaths50)



mortality_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    deaths = Deaths,
    age) %>%
  left_join(mortality_50, by = c("FIPS", "year")) %>%
  mutate(deaths_suppressed = deaths - deaths50) %>%
  select(FIPS, year, age, deaths_suppressed)

#add to mortality data frame
mortality_one %<>% left_join(mortality_suppressed, by = c("FIPS", "year", "age"))

mortality_one %<>%
 {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths)),
     x %>%
       filter(is.na(deaths)) %>%
       mutate(deaths = deaths_suppressed))
 }

#Adjust to US 2000 standard population
std_pop <- read_table('C:/Users/Harrison Kirby/Desktop/GLP/ccu18/data/health/stdpop.singleagesthru84.txt',
                      col_names = FALSE)

std_pop %<>%
  transmute(geography = str_sub(X1, 1, 3),
            age = str_sub(X1, 4, 6),
            pop = str_sub(X1, 7)) %>%
  mutate_all(as.numeric) %>%
  filter(geography == 202 & age < 75) %>%
  mutate(age_pct_std = pop / sum(pop)) %>%
  select(age, age_pct_std)


mortality <- mortality_one %>%
  left_join(std_pop) %>%
  group_by(FIPS, year) %>%
  mutate(age_pct = population / sum(population)) %>%
  mutate(population = population * age_pct_std / age_pct,
         deaths = deaths * age_pct_std / age_pct) %>% 
  ungroup()

#YPLL Calculation

mortality <- mortality %>%
  mutate(years_lost = 75 - age, 
         year_loss = years_lost * deaths)

mortality <- mortality %>%
  group_by(year, FIPS) %>%
  mutate(total_population = sum(population, na.rm = TRUE)) %>%
  filter(age < 75) %>%
  mutate(total_ypll = sum(year_loss, na.rm = TRUE),
         ypll = total_ypll / (total_population / 100000)) %>%
  ungroup() %>%
  filter(age == 0) %>%
  select(FIPS, year, ypll)

mortality %<>%
  mutate(FIPS = as.numeric(FIPS)) %>%
  weight_stl("ypll")

rm(mortality_50, mortality_suppressed)
```

```{r mortalityrace}

#read in single-year race mortality data

mortality_one_race <- read_tsv("data/health/mortality/one_race.txt")

#clean data frame

mortality_one_race %<>%
  filter(!is.na(Year)) %>%
  transmute(
    FIPS = `County Code`,
    year = Year,
    age = `Single-Year Ages Code`,
    race = Race,
    race = replace(race, race == "Black or African American", "black"),
    race = replace(race, race == "White", "white"),
    population = as.numeric(Population),
    deaths = as.numeric(Deaths))

#create new data frame from mortality_one containing one row for each combination of FIPS, year, and race. Then add existing data from mortlity_one_race

mortality_race <- mortality_one %>%
  select(FIPS, year, age) %>%
  {
    x <- .
    bind_rows(
      x %>% mutate(race = "black"),
      x %>% mutate(race = "white"))
  } %>%
  left_join(mortality_one_race, by = c("FIPS", "year", "age", "race")) %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>% 
        select(-race) %>%
        rename(pop_white = population, deaths_white = deaths),
      x %>% 
        filter(race == "black") %>% 
        select(-race) %>%
        rename(pop_black = population, deaths_black = deaths),
      by = c("FIPS", "year", "age"))
  }

#read in mortality data for white and black residents that is not broken down by race, then clean data frame and add to mortality_race
mortality_one_totals <- read_tsv("data/health/mortality/total_race.txt")

mortality_one_totals %<>%
  filter(!is.na(Year)) %>%
  transmute(
    FIPS = `County Code`,
    year = Year,
    age = as.numeric(`Single-Year Ages Code`),
    pop_tot = as.numeric(Population),
    deaths_tot = as.numeric(Deaths))

mortality_race %<>% 
  left_join(mortality_one_totals, by = c("FIPS", "year", "age")) 

#Fill any missing white values for age 74 using totals and data for black residents 

mortality_race %<>%
  {
    x <- .
    bind_rows(
      x %>% 
        filter(is.na(pop_white) & age == 74) %>%
        mutate(
          pop_white = pop_tot - pop_black,
          deaths_white = deaths_tot - deaths_black),
      
      x %>% 
        filter(!(is.na(pop_white) & age == 74)))
  }

#Read in death rates for ages added to death rates for age 74

mortality_tot_suppressed <- wonder_time_single("data/health/mortality/single-year whiteblack")

#filter mortality_race to age 74

mortality_74 <- mortality_race %>%
  filter(age == 74) %>%
  rename(deaths74 = deaths_tot,
         pop74 = pop_tot) %>%
  select(FIPS, year, deaths74, pop74)

#add to new totals dataframe and subtract deaths for ages 74 from deaths for age 74 plus each other age to create variables for surpressed population andd death counts

mortality_tot_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    age,
    deaths = Deaths,
    pop = Population) %>%
  left_join(mortality_74, by = c("FIPS", "year")) %>%
  mutate(
    deaths = as.numeric(deaths),
    deaths_tot_suppressed = deaths - deaths74,
    pop_tot_suppressed = pop - pop74) %>%
  select(FIPS, year, age, deaths_tot_suppressed, pop_tot_suppressed)

#add to mortality data frame
mortality_race %<>% left_join(mortality_tot_suppressed, by = c("FIPS", "year", "age"))


#replace NA values with calculated values
mortality_race %<>%
  {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths_tot)),
     x %>%
       filter(is.na(deaths_tot)) %>%
       mutate(deaths_tot = deaths_tot_suppressed,
              pop_tot = pop_tot_suppressed))
  } %>%
  select(-deaths_tot_suppressed, -pop_tot_suppressed)


#repeat the process for white residents.

#read in white data
mortality_white_suppressed <- wonder_time_single("data/health/mortality/single-year white")

#subset mortality_race to 74 year olds

mortality_74 <- mortality_race %>%
  filter(age == 74) %>%
  rename(deaths74 = deaths_white,
         pop74 = pop_white) %>%
  select(FIPS, year, deaths74, pop74)

#add to new totals dataframe and subtract deaths for ages 74 from deaths for age 74 plus each other age to create variables for surpressed population andd death counts 

mortality_white_suppressed %<>%
  select(
    FIPS = `County Code`,
    year = Year,
    age,
    deaths = Deaths,
    pop = Population) %>%
  mutate(age = age - 1) %>%
  left_join(mortality_74, by = c("FIPS", "year")) %>%
  mutate(
    deaths = as.numeric(deaths),
    deaths_white_suppressed = deaths - deaths74,
    pop_white_suppressed = pop - pop74) %>%
  select(FIPS, year, age, deaths_white_suppressed, pop_white_suppressed)

#add to mortality data frame
mortality_race %<>% left_join(mortality_white_suppressed, by = c("FIPS", "year", "age"))

#replace NA values with calculated values, calculate black values based on complete white and total columns
mortality_race %<>%
 {
   x <- .
   bind_rows(
     x %>%
       filter(!is.na(deaths_white)),
     x %>%
       filter(is.na(deaths_white)) %>%
       mutate(deaths_white = deaths_white_suppressed,
              pop_white = pop_white_suppressed))
 } %>%
 select(-deaths_white_suppressed, -pop_white_suppressed)
 
#Clean data frame
mortality_race %<>%
  transmute(
    FIPS, year, age,
    population_white = pop_white,
    population_black = pop_black,
    deaths_white, 
    deaths_black)

#YPLL Calculation

mortality_race <- mortality_race %>%
  mutate(years_lost = 75 - age, 
         year_loss_white = years_lost * deaths_white,
         year_loss_black = years_lost * deaths_black)

mortality_race <- mortality_race %>%
  group_by(year, FIPS) %>%
  mutate(
    total_population_white = sum(population_white, na.rm = TRUE),
    total_population_black = sum(population_black, na.rm = TRUE)) %>%
  filter(age < 75) %>%
  mutate(
    total_ypll_white = sum(year_loss_white, na.rm = TRUE),
    total_ypll_black = sum(year_loss_black, na.rm = TRUE),
    ypll_white = total_ypll_white / (total_population_white / 100000),
    ypll_black = total_ypll_black / (total_population_black / 100000)) %>%
  ungroup() %>%
  filter(age == 0) %>%
  select(FIPS, year, ypll_white, ypll_black)

mortality_race %<>%
  mutate(FIPS = as.numeric(FIPS)) %>%
  weight_stl(c("ypll_white", "ypll_black"))

mortality %<>% bind_df(mortality_race)

rm(mortality_74, mortality_age, mortality_one, mortality_one_race, mortality_one_totals, mortality_ten, mortality_tot_suppressed, mortality_white_suppressed, mortality_race)
```

```{r brfssquick}
brfss_results <- read_feather("data/health/brfss_results_basic.feather")
```

```{r brfss, eval = FALSE}
brfss <- read_feather("data/health/brfss.feather")

brfss <- brfss %>% rename(MSA = msa) %>% pull_peers_MSA()

#recode data
brfss$age[brfss$year >= 2003] <- plyr::mapvalues(brfss$age[brfss$year >= 2011], 1:6, c(1, 1, 1, 2, 2, 3))

brfss$poor_or_fair <- if_else(brfss$hlth == 4 | brfss$hlth == 5, 1, 0)
brfss$poor_or_fair[brfss$hlth == 7 | brfss$hlth == 9] <- NA

brfss$physdays[brfss$physdays == 77 | brfss$physdays == 99] <- NA
brfss$physdays[brfss$physdays == 88] <- 0

brfss$mentdays[brfss$mentdays == 77 | brfss$mentdays == 99] <- NA
brfss$mentdays[brfss$mentdays == 88] <- 0

brfss <- brfss %>% filter(year > 2003)

#create survey objects
brfss_svy <- svydesign(ids = ~0, weights = ~wgt, data = brfss)
pop_age <- c(0.530534557, 0.299194019, 0.170271424)

#brfss_svy_std <- svystandardize(brfss_svy, by = ~age, over = ~MSA+year, population = pop_age, excluding.missing = ~poor_or_fair+physdays+mentdays)

#brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy_std, svymean, na.rm = TRUE) %>%
#  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy, svymean, na.rm = TRUE) %>%
  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results$city<-NA
brfss_results$city[brfss_results$MSA == 24340] = "Grand Rapids"
brfss_results$city[brfss_results$MSA == 41180] = "St. Louis"
brfss_results$city[brfss_results$MSA == 36420] = "Oklahoma City"
brfss_results$city[brfss_results$MSA == 46140] = "Tulsa"
brfss_results$city[brfss_results$MSA == 24860] = "Greenville"
brfss_results$city[brfss_results$MSA == 28940] = "Knoxville"
brfss_results$city[brfss_results$MSA == 13820] = "Birmingham"
brfss_results$city[brfss_results$MSA == 31140] = "Louisville"
brfss_results$city[brfss_results$MSA == 26900] = "Indianapolis"
brfss_results$city[brfss_results$MSA == 28140] = "Kansas City"
brfss_results$city[brfss_results$MSA == 36540] = "Omaha"
brfss_results$city[brfss_results$MSA == 24660] = "Greensboro"
brfss_results$city[brfss_results$MSA == 16740] = "Charlotte"
brfss_results$city[brfss_results$MSA == 18140] = "Columbus"
brfss_results$city[brfss_results$MSA == 17140] = "Cincinnati"
brfss_results$city[brfss_results$MSA == 34980] = "Nashville"
brfss_results$city[brfss_results$MSA == 32820] = "Memphis"
brfss_results$city[brfss_results$MSA == 27260] = "Jacksonville"
brfss_results$city[brfss_results$MSA == 39580] = "Raleigh"
brfss_results$city[brfss_results$MSA == 19380] = "Dayton"
brfss_results$city[brfss_results$MSA == 40060] = "Richmond"

g_2015 <- brfss_results[brfss_results$city == "Greensboro" & brfss_results$year == 2014, 1:6]
g_2015$year <- 2015

brfss_results <- rbind(brfss_results, g_2015)

g_2015$year <- 2016
brfss_results <- rbind(brfss_results, g_2015)

brfss_results %<>% select(MSA, year, city, everything())

rm(g_2015, brfss, brfss_svy, std_pop)

write_feather(brfss_results, "data/health/brfss_results_basic.feather")
```

```{r quickbrfssrace}
brfss_results_race <- read_feather("data/health/brfss_results.feather")

brfss_results <- full_join(brfss_results, brfss_results_race, by = c("MSA", "year")) %>% select(-city)

brfss_results %<>%
  mutate(poor_or_fair = poor_or_fair * 100)
            

rm(brfss_results_race)
```

```{r brfssrace, eval = FALSE}
brfss <- read_feather("data/health/brfss_race.feather")

brfss <- brfss %>% rename(MSA = msa) %>% pull_peers_MSA()

#recode data
brfss$age[brfss$year >= 2003] <- plyr::mapvalues(brfss$age[brfss$year >= 2011], 1:6, c(1, 1, 1, 2, 2, 3))

brfss$race <- replace(brfss$race, brfss$race >3, NA)
brfss$race <- replace(brfss$race, brfss$race == 1, "white")
brfss$race <- replace(brfss$race, brfss$race == 2, "black")
brfss$race <- replace(brfss$race, brfss$race == 3, "hisp")

brfss$poor_or_fair <- if_else(brfss$hlth == 4 | brfss$hlth == 5, 1, 0)
brfss$poor_or_fair[brfss$hlth == 7 | brfss$hlth == 9] <- NA

brfss$physdays[brfss$physdays == 77 | brfss$physdays == 99] <- NA
brfss$physdays[brfss$physdays == 88] <- 0

brfss$mentdays[brfss$mentdays == 77 | brfss$mentdays == 99] <- NA
brfss$mentdays[brfss$mentdays == 88] <- 0

brfss <- brfss %>% filter(year > 2003)

#create survey objects
brfss_svy <- svydesign(ids = ~0, weights = ~wgt, data = brfss)
pop_age <- c(0.530534557, 0.299194019, 0.170271424)

#brfss_svy_std <- svystandardize(brfss_svy, by = ~age, over = ~MSA+year, population = pop_age, excluding.missing = ~poor_or_fair+physdays+mentdays)

#brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year, design = brfss_svy_std, svymean, na.rm = TRUE) %>%
#  select(MSA, year, poor_or_fair, physdays, mentdays)

brfss_results <- svyby(~poor_or_fair+physdays+mentdays, by = ~MSA+year+race, design = brfss_svy, svymean, na.rm = TRUE) %>%
  select(MSA, year, race, poor_or_fair, physdays, mentdays) %>%
  mutate(poor_or_fair = poor_or_fair * 100)

brfss_results$city<-NA
brfss_results$city[brfss_results$MSA == 24340] = "Grand Rapids"
brfss_results$city[brfss_results$MSA == 41180] = "St. Louis"
brfss_results$city[brfss_results$MSA == 36420] = "Oklahoma City"
brfss_results$city[brfss_results$MSA == 46140] = "Tulsa"
brfss_results$city[brfss_results$MSA == 24860] = "Greenville"
brfss_results$city[brfss_results$MSA == 28940] = "Knoxville"
brfss_results$city[brfss_results$MSA == 13820] = "Birmingham"
brfss_results$city[brfss_results$MSA == 31140] = "Louisville"
brfss_results$city[brfss_results$MSA == 26900] = "Indianapolis"
brfss_results$city[brfss_results$MSA == 28140] = "Kansas City"
brfss_results$city[brfss_results$MSA == 36540] = "Omaha"
brfss_results$city[brfss_results$MSA == 24660] = "Greensboro"
brfss_results$city[brfss_results$MSA == 16740] = "Charlotte"
brfss_results$city[brfss_results$MSA == 18140] = "Columbus"
brfss_results$city[brfss_results$MSA == 17140] = "Cincinnati"
brfss_results$city[brfss_results$MSA == 34980] = "Nashville"
brfss_results$city[brfss_results$MSA == 32820] = "Memphis"
brfss_results$city[brfss_results$MSA == 27260] = "Jacksonville"
brfss_results$city[brfss_results$MSA == 39580] = "Raleigh"
brfss_results$city[brfss_results$MSA == 19380] = "Dayton"
brfss_results$city[brfss_results$MSA == 40060] = "Richmond"

g_2015 <- brfss_results[brfss_results$city == "Greensboro" & brfss_results$year == 2014, 1:7]
g_2015$year <- 2015

brfss_results <- rbind(brfss_results, g_2015)

g_2015$year <- 2016
brfss_results <- rbind(brfss_results, g_2015)

brfss_results <- brfss_results %>%
  {
    x <- .
    
    first <- full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_white = poor_or_fair,
               physdays_white = physdays,
               mentdays_white = mentdays),
      x %>% 
        filter(race == "black") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_black = poor_or_fair,
               physdays_black = physdays,
               mentdays_black = mentdays),
      by = c("MSA", "year"))
    
    second <-
      full_join(
      first,
      x %>% 
        filter(race == "hisp") %>%
        select(-race, -city) %>%
        rename(poor_or_fair_hispanic = poor_or_fair,
               physdays_hispanic = physdays,
               mentdays_hispanic = mentdays),
      by = c("MSA", "year"))
  }
write_feather(brfss_results, "data/health/brfss_results.feather")
```

```{r process}
msa_fips <- read_csv('data/MSA to FIPS.csv') %>% select(-city) %>% mutate(FIPS = as.character(FIPS))

natality <- left_join(natality, msa_fips)

#Create index
health_index <- full_join(mortality, natality, by = c("FIPS", "year"))
health_index <- full_join(health_index, brfss_results, by = c("MSA", "year"))

health_index <- health_index %>%
  pull_peers_FIPS() %>%
  select(-MSA) %>%
  select(FIPS, year, city, current, baseline, everything())

#Create index
norm_z <- function(x){
  z <- (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}

health_z <- health_index %>% filter(current == 1)
health_z <- map_df(health_z, remove_var_label)

health_z <- health_z %>%
  group_by(year) %>%
  mutate_at(vars(5:22), norm_z) %>%
  mutate_at(vars(5:22), funs(. * -1)) %>%
  ungroup() %>%
  rename_at(vars(6:23), paste0, "_index")

health_z <- health_z %>%
  mutate(
    health_index = 
      ypll_index * .5 +
      pct_underweight_index * .2 +
      poor_or_fair_index * .1 +
      physdays_index * .1 +
      mentdays_index * .1,
    
    health_index_white = 
      ypll_white_index * .5 +
      pct_underweight_white_index * .2 +
      poor_or_fair_white_index * .1 +
      physdays_white_index * .1 +
      mentdays_white_index * .1,
    
    health_index_black = 
      ypll_black_index * .5 +
      pct_underweight_black_index * .2 +
      poor_or_fair_black_index * .1 +
      physdays_black_index * .1 +
      mentdays_black_index * .1)

data <- health_index %>% 
  select(-city, -current, -baseline) %>%
  bind_df(health_z)

rm(msa_fips, natality, mortality, brfss_results)
```

```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "health_index", 
                  plot_title = "Health Index, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

## 2. Trendline {.tabset}

### Overall

```{r graph17}
graph_trendline(
  data,
  "health_index",
  plot_title = "Health Index",
  rollmean = 3)
```

### by Race
```{r}
graph_trendline_race_peer_two(
  data, 
  vars = c('health_index_white', "health_index_black"),
  plot_title = "Health Index by Race",
  xmin = 2005,
  rollmean = 3)
```

## 3. Years of Potential Life Lost {.tabset}

### Overall

```{r}
graph_trendline(
  data,
  var = 'ypll',
  rollmean = 3,
  plot_title = "Years of potential life lost per 100,000 Residents",
  y_title="Years",
  xmin = 2000,
  xmax = 2016)
```

### by Race

```{r}
graph_trendline_race_peer_two(
  data, 
  vars = c('ypll_white', "ypll_black"),
  plot_title = "YPLL",
  xmin = 2000,
  rollmean = 3)
```

## 4. Underweight Births {.tabset}

### Overall

```{r}
graph_trendline(
  data,
  var = 'pct_underweight',
  rollmean = 3,
  plot_title = "Underweight Births",
  y_title="Years",
  xmin = 2003,
  xmax = 2016)
```

### by Race

```{r}
graph_trendline_race_peer_two(
  data, 
  vars = c('pct_underweight_white', "pct_underweight_black"),
  plot_title = "Underweight Births",
  xmin = 2003,
  rollmean = 3)
```

## 5. Poor or Fair Health

### Overall

```{r}
graph_trendline(
  data,
  var = 'poor_or_fair',
  rollmean = 3,
  plot_title = "Poor or Fair Health",
  y_title = "Percent",
  xmin = 2004,
  xmax = 2016)
```

### by Race

```{r}
graph_trendline_race_peer(
  data, 
  vars = c('poor_or_fair_white', "poor_or_fair_black", "poor_or_fair_hispanic"),
  plot_title = "Poor or Fair Healthy",
  xmin = 2004,
  rollmean = 3)
```

## 6. Physically Healthy Days

### Overall

```{r}
graph_trendline(
  data,
  var = 'physdays',
  rollmean = 3,
  plot_title = "Physically Healthy Days",
  y_title="Years",
  xmin = 2004,
  xmax = 2016)
```

### by Race

```{r}
graph_trendline_race_peer(
  data, 
  vars = c('physdays_white', "physdays_black", "physdays_hispanic"),
  plot_title = "Physically Unhealthy Days",
  xmin = 2004,
  rollmean = 3)
```

## 7. Physically Healthy Days

### Overall

```{r}
graph_trendline(
  data,
  var = 'mentdays',
  rollmean = 3,
  plot_title = "Mentally Healthy Days",
  y_title="Years",
  xmin = 2004,
  xmax = 2016)
```

### by Race

```{r}
graph_trendline_race_peer(data, 
                          vars = c('mentdays_white', "mentdays_black", "mentdays_hispanic"),
                          plot_title = "Mentally Healthy Days",
                          xmin = 2004)
```

# Health Factors
```{r}
chr <- read_csv("data/health/chr_measures_CSV_2018.csv")

chr %<>%
  mutate(FIPS = paste0(`FIPS State Code`, `FIPS County Code`)) %>%
  pull_peers_FIPS() %>%
  select(
    FIPS,
    premature_death = measure_1_value,
    poor_or_fair_health = measure_2_value,
    poor_physical_health_days = measure_36_value,
    poor_mental_health_days = measure_42_value,
    low_birthweight = measure_37_value,
    adult_smoking = measure_9_value,
    adult_obesity = measure_11_value,
    food_environment_index = measure_133_value,
    physical_inactivity = measure_70_value,
    access_to_exercise_opportunities = measure_132_value,
    excessive_drinking = measure_49_value,
    alcohol_impaired_driving_deaths = measure_134_value,
    sexually_transmitted_infections = measure_45_value,
    teen_births = measure_14_value,
    uninsured = measure_85_value,
    primary_care_physicians = measure_4_value,
    dentists = measure_88_value,
    mental_health_providers = measure_62_value,
    preventable_hospital_stays = measure_5_value,
    diabetes_monitoring = measure_7_value,
    mammography_screening = measure_50_value,
    high_school_graduation = measure_21_value,
    some_college = measure_69_value,
    unemployment = measure_23_value,
    children_in_poverty = measure_24_value,
    income_inequality = measure_44_value,
    children_in_single_parent_households = measure_82_value,
    social_associations = measure_140_value,
    violent_crime = measure_43_value,
    injury_deaths = measure_135_value,
    air_pollution = measure_125_value,
    drinking_water = measure_124_value,
    severe_housing_problems = measure_136_value,
    driving_alone_to_work = measure_67_value,
    long_commute = measure_137_value) %>%
  mutate(
    year = 2016,
    FIPS = as.numeric(FIPS)) %>%
  mutate_at(
    vars(poor_or_fair_health, low_birthweight, adult_smoking, adult_obesity, physical_inactivity,
         access_to_exercise_opportunities, excessive_drinking, alcohol_impaired_driving_deaths, uninsured,
         diabetes_monitoring, mammography_screening, severe_housing_problems, driving_alone_to_work,
         long_commute),
    funs(. * 100))

chr %<>%
  weight_stl(names(chr)[names(chr) %!in% c("FIPS", "year")])

norm_z <- function(x){
  z <- (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}

chr_z <- chr 

chr_z %<>% 
  mutate_at(
    vars(names(chr_z)[names(chr_z) %!in% c("FIPS", "year")]), 
    norm_z)

chr_z %<>%
  mutate(
    outcomes = 
      premature_death * -0.5 +
      poor_or_fair_health * -0.1 +
      poor_physical_health_days * -0.1 +
      poor_mental_health_days * -0.1 +
      low_birthweight * -0.1,
    
    health_behaviors = 
      adult_smoking * -0.1 +
      adult_obesity * -0.05 +
      food_environment_index * 0.02 +
      physical_inactivity * 0.02 +
      access_to_exercise_opportunities * 0.01 +
      excessive_drinking * -0.025 +
      alcohol_impaired_driving_deaths * -0.025 +
      sexually_transmitted_infections * -0.025 +
      teen_births * -0.025,
    
    clinical_care = 
      uninsured * -0.05 +
      primary_care_physicians * 0.03 +
      dentists * 0.01 +
      mental_health_providers * 0.01 +
      preventable_hospital_stays * -0.05 +
      diabetes_monitoring * 0.025 +
      mammography_screening * 0.025,
    
    social_and_economic = 
      high_school_graduation * 0.05 +
      some_college * 0.05 +
      unemployment * -0.10 +
      children_in_poverty * -0.075 +
      income_inequality * -0.025 +
      children_in_single_parent_households * -0.025 +
      social_associations * 0.025 +
      violent_crime * -0.025 +
      injury_deaths * -0.025,
    
    physical_environment = 
      air_pollution * -0.05 +
      severe_housing_problems * -0.02 +
      driving_alone_to_work * -0.02 +
      long_commute * -0.01,
    
    factors = health_behaviors + clinical_care + social_and_economic + physical_environment) %>%
  rename_at(
    vars(names(chr_z)[names(chr_z) %!in% c("FIPS", "year", "outcomes", "health_behaviors", "clinical_care", "social_and_economic", "physical_environment", "factors")]),
    funs(paste0(., "_z")))

data %<>% bind_df(chr_z)
  
```

## 1. Social and Economic Factors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "social_and_economic", 
                  plot_title = "Social and Economic Health Factors, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

## 2. Health Behaviors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "health_behaviors", 
                  plot_title = "Health Behaviors, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

## 3. Clinical Care
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "clinical_care", 
                  plot_title = "Clinical Care, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

## 4. Social and Economic Factors
```{r}
rank_and_nb_group(data[data$year == 2016,],
                  "physical_environment", 
                  plot_title = "Physical Environment, 2016",
                  y_title = "Average Peer City", 
                  text = FALSE,
                  h_line = TRUE)
```

# Health Insurance
```{r data20.1}
insurance <- acs_time("/data/health/C27001/", starting_year = 2009)

insurance %<>%
  mutate(
    total = `Estimate; Total:`,
    
    uninsured_rate =
      (`Estimate; Male: - Under 18 years: - No health insurance coverage` +
      `Estimate; Male: - 18 to 64 years: - No health insurance coverage` + 
      `Estimate; Male: - 65 years and over: - No health insurance coverage` +
      `Estimate; Female: - Under 18 years: - No health insurance coverage` +
      `Estimate; Female: - 18 to 64 years: - No health insurance coverage` + 
      `Estimate; Female: - 65 years and over: - No health insurance coverage`)
      / total * 100,
    
    insured_rate = 100 - uninsured_rate) %>%
  weight_stl('insured_rate', 'total')


data %<>% bind_df(insurance)

data %<>% select(FIPS, city, year, current, baseline, everything())

rm(insurance)
```
## 5. Ranking

```{r graph 20.4}
rank_and_nb_group(data[data$year == 2016,],
                  'insured_rate',
                  plot_title = 'Health Insurance, 2016')
```

# Overdoses
```{r race, eval = FALSE}
opioid <- read_tsv('data/health/overdoses/overdose.txt')

opioid %<>%
  filter(!is.na(Year)) %>%
  mutate(
    FIPS = as.numeric(`County Code`),
    year = Year,
    deaths = as.numeric(Deaths),
    population = as.numeric(Population),
    overdose = `Age Adjusted Rate`,
    overdose = replace(overdose, overdose == "Unreliable", deaths / population * 1000),
    overdose = as.numeric(overdose)) %>%
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, `Drug/Alcohol Induced Code`) %>%
  summarise(
    overdose = weighted.mean(overdose, population),
    deaths = sum(deaths),
    population = sum(population)) %>%
  ungroup() %>%
  group_by(year, FIPS) %>%
  mutate(total_deaths = sum(deaths)) %>%
  ungroup() %>%
  filter(`Drug/Alcohol Induced Code` == "D") %>%
  mutate(
    overdose_per = deaths / total_deaths * 100) %>%
  select(
    year, FIPS,
    overdose,
    overdose_per)

opioid_race <- read_tsv('data/health/overdoses/overdose_race.txt')

opioid_race %<>%
  #delete notes rows
  filter(!is.na(Year)) %>%
  
  #mutate variables
  transmute(
    FIPS = as.numeric(`County Code`),
    year = Year,
    `Drug/Alcohol Induced Code`,
    race = replace(Race, Race == "American Indian or Alaska Native", "AIAN"),
    race = replace(race, Race == "Asian or Pacific Islander", "API"),
    race = replace(race, Race == "Black or African American", "black"),
    race = replace(race, Race == "White", "white"),
    deaths = as.numeric(Deaths),
    population = as.numeric(Population),
    overdose = `Age Adjusted Rate`,
    overdose = replace(overdose, overdose == "Unreliable", deaths / population * 1000),
    overdose = as.numeric(overdose)) %>%
  
  #weight STL
  mutate(FIPS = replace(FIPS, FIPS == '29189' | FIPS == '29510', 'MERGED')) %>%
  group_by(FIPS, year, `Drug/Alcohol Induced Code`, race) %>%
  summarise(
    overdose = weighted.mean(overdose, population),
    deaths = sum(deaths),
    population = sum(population)) %>%
  ungroup() %>%
  
  #calculate percent of deaths
  group_by(year, FIPS, race) %>%
  mutate(total_deaths = sum(deaths)) %>%
  ungroup() %>%
  
  #filter to overdoses
  filter(`Drug/Alcohol Induced Code` == "D") %>%
  mutate(
    overdose_per = deaths / total_deaths * 100) %>%
  select(
    year, FIPS, race,
    overdose,
    overdose_per) %>%
  {
    x <- .
    full_join(
      x %>% 
        filter(race == "white") %>%
        select(-race) %>%
        rename(overdose_white = overdose, overdose_white_per = overdose_per),
      x %>% 
        filter(race == "black") %>%
        select(-race) %>%
        rename(overdose_black = overdose, overdose_black_per = overdose_per),
      by = c("FIPS", "year"))
  }

opioid %<>% pull_peers_FIPS()
opioid %<>% bind_df(opioid_race)
```

```{r}
#read in, clean, and join files:

#total number of deaths
total_deaths <- read_tsv("data/health/overdoses/age/total_deaths.txt")

#total number of non-overdose deaths
non_od_deaths <- read_tsv("data/health/overdoses/age/non_overdose_deaths.txt")

#total number of deaths for each age combined with age 74
unsuppressed_total_deaths <- wonder_time_single("data/health/overdoses/age/single-age_total_deaths")

#total number of non-overdose deaths for each age combined with age 74
unsuppressed_non_od_deaths <- wonder_time_single("data/health/overdoses/age/single-age_non_od_deaths")

total_deaths %<>% 
  clean_wonder() %>%
  rename(total_deaths = deaths)

non_od_deaths %<>% 
  clean_wonder() %>%
  rename(non_od_deaths = deaths) %>%
  select(-population)

unsuppressed_total_deaths %<>%
  clean_wonder() %>%
  rename(total_deaths_plus_74 = deaths,
         pop_plus_74 = population)

unsuppressed_non_od_deaths %<>%
  clean_wonder() %>%
  rename(non_od_deaths_plus_74 = deaths) %>%
  select(-population)

overdose <- 
  full_join(total_deaths, non_od_deaths, by =  c("FIPS", "year", "age")) %>%
  full_join(unsuppressed_total_deaths, by =  c("FIPS", "year", "age")) %>%
  full_join(unsuppressed_non_od_deaths, by =  c("FIPS", "year", "age"))

#extract values for age 74 and append to data frame
overdose74 <- overdose %>%
  filter(age == 74) %>%
  select(
    FIPS, year,
    total_deaths_74 = total_deaths,
    non_od_deaths_74 = non_od_deaths)

overdose %<>%
  filter(age < 75) %>%
  left_join(overdose74, by = c("FIPS", "year"))

#calculate missing values by subtracting the value for age 74 from (the value for that age + the value for age 74)
overdose %<>%
  {
    x <- .
    bind_rows(
      x %>% filter(age < 50) %>%
        mutate(
          total_deaths = total_deaths_plus_74 - total_deaths_74,
          non_od_deaths = non_od_deaths_plus_74 - non_od_deaths_74),
      x %>% filter(age >= 50))
  }

#calculate overdose rates
overdose %<>%
  mutate(od_deaths = total_deaths - non_od_deaths) %>%
  select(FIPS, year, age, population, od_deaths) %>%
  stl_adj_wonder()

#ypll calculation
overdose_ypll <- overdose %>%
  group_by(FIPS, year) %>%
  mutate(
    years_lost = 75 - age,
    od_years_lost = od_deaths * years_lost) %>%
  ungroup() %>%
  age_adj_rate(var = "od_years_lost") %>%
  rename(overdose_ypll = rate)

od_rate <- overdose %>%
  age_adj_rate(var = "od_deaths") %>%
  rename(overdose_rate = rate)

overdose_count <- overdose %>%
  select(-age) %>%
  group_by(FIPS, year) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(FIPS, year, od_deaths) %>%
  rename(overdoses = od_deaths)

overdose <- bind_df(overdose_ypll, od_rate, overdose_count)
```

```{r}
setwd("data/health/overdoses/cause/all_years")

cocaine <- read_tsv("cocaine.txt")
fentanyl <- read_tsv("fentanyl.txt")
heroin <- read_tsv("heroin.txt")
meth <- read_tsv("methamphetamine.txt")
opioid <- read_tsv("opioid.txt")
prescription <- read_tsv("prescription opioid.txt")

cocaine %<>%
  clean_wonder() %>%
  rename(cocaine = deaths)

fentanyl %<>%
  clean_wonder() %>%
  rename(fentanyl = deaths) %>%
  select(-population)

heroin %<>%
  clean_wonder() %>%
  rename(heroin = deaths) %>%
  select(-population)

meth %<>%
  clean_wonder() %>%
  rename(meth = deaths) %>%
  select(-population)

opioid %<>% 
  clean_wonder() %>%
  rename(opioid = deaths) %>%
  select(-population)
  
prescription %<>%
  clean_wonder() %>%
  rename(prescription = deaths) %>%
  select(-population)

od_all_years <- full_join(cocaine, fentanyl) %>%
  full_join(heroin) %>%
  full_join(meth) %>%
  full_join(opioid) %>%
  full_join(prescription)

od_all_years %<>%
  rename_at(vars(cocaine, fentanyl, heroin, meth, opioid, prescription, population), paste0, "_all")


setwd("../single-year_excluded")

opioid <- wonder_time_single("opioid", seq_var = "year", start = 1999)
prescription <- wonder_time_single("prescription opioid", seq_var = "year", start = 1999)
other <- wonder_time_single("other", seq_var = "year", start = 1999)

opioid %<>% 
  clean_wonder() %>%
  rename(opioid = deaths) %>%
  select(-population)
  
prescription %<>%
  clean_wonder() %>%
  rename(prescription = deaths) %>%
  select(-population)

other %<>%
  clean_wonder() %>%
  mutate(
    cod = replace(cod, cod == "T40.1", "heroin"),
    cod = replace(cod, cod == "T40.4", "fentanyl"),
    cod = replace(cod, cod == "T40.5", "cocaine"),
    cod = replace(cod, cod == "T43.6", "meth")) %>%
  spread(key = "cod", value = "deaths")

od_excluding <- full_join(opioid, prescription) %>%
  full_join(other)

od_excluding %<>%
  rename_at(vars(cocaine, fentanyl, heroin, meth, opioid, prescription, population), paste0, "_excluding")

od <- full_join(od_all_years, od_excluding, by = "FIPS")

od %<>%
  transmute(
    FIPS, year,
    population = population_all - population_excluding,
    cocaine = cocaine_all - cocaine_excluding, 
    fentanyl = fentanyl_all - fentanyl_excluding, 
    heroin = heroin_all - heroin_excluding, 
    meth = meth_all - meth_excluding, 
    opioid = opioid_all - opioid_excluding, 
    prescription = prescription_all - prescription_excluding) %>%
  stl_adj_wonder() %>%
  select(-population)
#%>% mutate_at(vars(cocaine, fentanyl, heroin, meth, opioid, prescription), . / population * 100000)
           
overdose %<>% bind_df(od) 

overdose$FIPS <- replace(overdose$FIPS, overdose$FIPS == "01073", "1073")

data %<>% bind_df(overdose) %>% select(-city, -baseline, -current) %>% pull_peers_FIPS()

```

## 9. Ranking

```{r}
rank_and_nb_group(data[data$year == 2016,],
                  'overdose_rate',
                  plot_title = 'Overdoses, 2016',
                  y_title = "Overdose Deaths per 100,000 residents",
                  order = "Ascending")
```

## 10. Trendline

```{r}
graph_trendline(data,
                'overdose_rate',
                plot_title = 'Overdoses',
                xmin = 2000,
                y_title = "Overdose Deaths per 100,000 residents")
```

## Overdoses by Drug

```{r fig.width = 10}
graph_df <- data %>% 
  filter(FIPS == 21111) %>%
  select(-FIPS) %>%
  select(year, overdoses, cocaine, fentanyl, heroin, meth, opioid, prescription) %>%
  gather(2:8, key = "CoD", value = "deaths") %>%
  filter(year > 1999)

graph_df$CoD <- factor(graph_df$CoD, 
                       levels = c("overdoses", "opioid", 
                                  "fentanyl", "heroin",
                                  "prescription", "meth", 
                                  "cocaine"),
                       labels = c("Total Overdoses", "All Opioids", 
                                  "Fentanyl", "Heroin",
                                  "Prescription Opioids", "Meth",
                                  "Cocaine"))

ggplot(graph_df, aes(x = year, y = deaths, color = CoD)) +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_color_hue(
    labels = c(
      overdoses = "ods",
      cocaine = "Cocaine",
      fentanyl =  "Fentanyl",
      heroin = "Heroin",
      meth = "Meth",
      opioid = "All Opioids",
      prescription = "Prescription Opioids"
    )) +
  scale_x_continuous(limits = c(2000, 2016), breaks = seq(2000, 2016, 4)) +
  theme_bw() + 
  theme(text = element_text(family = "Museo Sans 300"),
             legend.title=element_blank(),
             legend.position = "right",
             axis.text=element_text(size=24, family = "Museo Sans 300"),
             axis.ticks.y=element_blank(),
             plot.title=element_text(size=36, hjust=.5, family = "Museo Sans 300",
                                     margin=margin(b=10,unit="pt")),
             axis.title = element_text(size = 24),
             legend.text=element_text(size=18, family = "Museo Sans 300"),
             plot.caption = element_text(family = "Museo Sans 300", size = 18),
             plot.subtitle = element_text(family = "Museo Sans 300", hjust = 0.5, size = 18)) + 
  labs(title = "Overdose Deaths by Drug", 
       x = "Year",
       y = "overdoses", 
       caption = "Deaths can involve multiple drugs, so numbers do not sum to 100%.")


graph_df <- data %>% 
  filter(FIPS == 21111) %>%
  select(-FIPS) %>%
  select(year, overdoses, cocaine, fentanyl, heroin, meth, opioid, prescription) %>%
  gather(2:8, key = "CoD", value = "deaths") %>%
  filter(year > 2010)

graph_df$CoD <- factor(graph_df$CoD, 
                       levels = c("overdoses", "opioid", 
                                  "fentanyl", "heroin",
                                  "prescription", "meth", 
                                  "cocaine"),
                       labels = c("Total Overdoses", "All Opioids", 
                                  "Fentanyl", "Heroin",
                                  "Prescription Opioids", "Meth",
                                  "Cocaine"))

ggplot(graph_df, aes(x = year, y = deaths, color = CoD)) +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_color_hue(
    labels = c(
      overdoses = "ods",
      cocaine = "Cocaine",
      fentanyl =  "Fentanyl",
      heroin = "Heroin",
      meth = "Meth",
      opioid = "All Opioids",
      prescription = "Prescription Opioids"
    )) +
  scale_x_continuous(limits = c(2011, 2016), breaks = seq(2011, 2016, 1)) +
  theme_bw() + 
  theme(text = element_text(family = "Museo Sans 300"),
             legend.title=element_blank(),
             legend.position = "right",
             axis.text=element_text(size=24, family = "Museo Sans 300"),
             axis.ticks.y=element_blank(),
             plot.title=element_text(size=36, hjust=.5, family = "Museo Sans 300",
                                     margin=margin(b=10,unit="pt")),
             axis.title = element_text(size = 24),
             legend.text=element_text(size=18, family = "Museo Sans 300"),
             plot.caption = element_text(family = "Museo Sans 300", size = 18),
             plot.subtitle = element_text(family = "Museo Sans 300", hjust = 0.5, size = 18)) + 
  labs(title = "Overdose Deaths by Drug", 
       x = "Year",
       y = "overdoses", 
       caption = "Deaths can involve multiple drugs, so numbers do not sum to 100%.")
  

```

## Overdose Hypothetical
```{r}
data %<>%
  mutate(ypll_minus_od = ypll - overdose_ypll)

hyp <- data %>%
  filter(current == 1) %>%
  group_by(year) %>%
  mutate(ypll_minus_od_index = -1 * norm_z(ypll_minus_od)) %>%
  ungroup()

hyp %<>%
  mutate(
    health_index_minus_od = 
      ypll_minus_od_index * .5 +
      pct_underweight_index * .2 +
      poor_or_fair_index * .1 +
      physdays_index * .1 +
      mentdays_index * .1)

```

## YPLL with and without overdoses {.tabset}

### Unadjusted
```{r}
graph_trendline(
  hyp,
  var = 'ypll',
  rollmean = 3,
  plot_title = "Years of potential life lost per 100,000 Residents",
  y_title="Years",
  xmin = 2000,
  xmax = 2016)
```

### Removing ODs
```{r}
graph_trendline(
  hyp,
  var = 'ypll_minus_od',
  rollmean = 3,
  plot_title = "Years of potential life lost per 100,000 Residents",
  y_title="Years",
  xmin = 2000,
  xmax = 2016)
```

## Health Index with and without overdoses {.tabset}

### Unadjusted
```{r}
graph_trendline(
  hyp,
  var = 'health_index',
  rollmean = 3,
  plot_title = "Health Index",
  y_title="Years",
  xmin = 2005,
  xmax = 2016)
```

### Without ODs
```{r}
graph_trendline(
  hyp,
  var = 'health_index_minus_od',
  rollmean = 3,
  plot_title = "Health Index",
  y_title="Years",
  xmin = 2005,
  xmax = 2016)
```

# Homocide {.tabset}
```{r}
homicide <- read_tsv("data/health/homicide/homicide.txt")

homicide %<>% 
  clean_wonder() %>%
  rename(homicide_rate = rate) %>%
  weight_stl("homicide_rate", "population") 

data %<>% bind_df(homicide)
```

## 3-year average
```{r}
graph_trendline(
  data,
  "homicide_rate",
  xmin = 2000,
  plot_title = "Homicide Rate",
  rollmean = 3,
  y_title = "Deaths per 100,000")
```

## single-year
```{r}
graph_trendline(
  data,
  "homicide_rate",
  xmin = 2000,
  plot_title = "Homicide Rate",
  y_title = "Deaths per 100,000")
```

# Suicide {.tabset}
```{r}
suicide <- read_tsv("data/health/suicide/total.txt")

suicide %<>%
  filter(!is.na(Year)) %>%
  select(
    FIPS = `County Code`,
    year = Year,
    pop = Population,
    suicide_rate = `Age Adjusted Rate`) %>%
  mutate_at(vars(year, pop, suicide_rate), as.numeric) %>%
  weight_stl("suicide_rate", "pop")

data %<>% bind_df(suicide)
```

## 3-year average
```{r}
graph_trendline(
  data,
  "suicide_rate",
  xmin = 2000,
  plot_title = "Suicide Rate",
  rollmean = 3,
  y_title="Deaths per 100,000")
```

## single-year
```{r}
graph_trendline(
  data,
  "suicide_rate",
  xmin = 2000,
  plot_title = "Suicide Rate",
  y_title="Deaths per 100,000")
```

# Life Expectancy
```{r data11}
#USALEEP
life_expectancy <- read_csv("data/health/KY_A.csv")

life_expectancy %<>%
  transmute(
    tract = as.character(`Tract ID`),
    life_expectancy = `e(0)`,
    se = `se(e(0))`,
    obs_type = `Abridged life table flag`)

#CHE
life_expectancy_che <- read_csv("data/health/CHE life expectancy.csv")

life_expectancy_che %<>%
  rename(
    market = `Market Area`,
    life_expectancy = `5 Year Life Expectancy`)

map_market@data %<>% full_join(life_expectancy_che)

```

```{r graph11}
map_tract@data %<>% 
  mutate(
    tract = str_sub(GEO_ID, 10))

map_tract@data <- left_join(map_tract@data, life_expectancy)

make_map(
  "life_expectancy", 
  name = "Life Expectancy",
  legend_title = "Life<br/>Expectancy",
  map_obj = "map_market",
  units = "years")

rm(life_expectancy)

map_market@data
```

```{r}
output <- data %>%
  select(-baseline, -current, -city) %>%
  {
    x <- .
    rbind(
      x %>%
        filter(FIPS == 21111) %>% 
        select(-FIPS) %>%
        mutate(observation_type = "Louisville"),
      x %>%
        filter(FIPS != 21111) %>%
        select(-FIPS) %>%
        group_by(year) %>%
        summarise_all(quantile, prob = 0.25, na.rm = TRUE) %>%
        mutate(observation_type = "Q1"),
      x %>%
        filter(FIPS != 21111) %>%
        select(-FIPS) %>%
        group_by(year) %>%
        summarise_all(mean, na.rm = TRUE) %>%
        mutate(observation_type = "mean"),
      x %>%  
        filter(FIPS != 21111) %>%
        select(-FIPS) %>%
        group_by(year) %>%
        summarise_all(quantile, prob = 0.75, na.rm = TRUE) %>%
        mutate(observation_type = "Q3"))
  }

output %<>%
  select(year, observation_type, everything()) %>%
  mutate_if(is.numeric, round, digits = 1)

write_csv(output, "output_data/health.csv")
```